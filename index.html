<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Frog Dashboard</title>
    <style>
        :root { --bg: #09090b; --card: #18181b; --text: #fafafa; --primary: #3b82f6; --success: #22c55e; --frog: #facc15; --milestone: #60a5fa; --danger: #ef4444; --border: #27272a; }
        
        * { box-sizing: border-box; }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; transition: background 1s ease; }
        
        .container { width: 100%; max-width: 1000px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; z-index: 1; }
        
        /* FOCUS OVERLAY */
        .focus-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; opacity: 0; pointer-events: none;
            transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 2000;
        }
        body.focus-mode .focus-overlay { opacity: 0.5; }

        /* Fireworks */
        .firework-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 99; }
        .particle { position: absolute; width: 5px; height: 5px; border-radius: 50%; animation: explode 1.2s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--x), var(--y)); opacity: 0; } }

        /* TOAST */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(24, 24, 27, 0.95); border: 1px solid var(--primary);
            color: #fff; padding: 20px 40px; border-radius: 50px;
            font-size: 1rem; font-weight: bold; pointer-events: none;
            opacity: 0; transition: opacity 0.4s ease; z-index: 3000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
        }
        .toast.show { opacity: 1; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 4000; }
        
        /* NOTE MODAL SPECIFIC (Large) */
        #richTextModal .sync-modal { max-width: 800px; width: 95%; height: 80vh; padding: 20px; }
        
        /* RICH TEXT EDITOR CSS */
        .editor-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; gap: 10px; }
        .editor-toolbar { display: flex; gap: 5px; background: #27272a; padding: 8px; border-radius: 8px; flex-wrap: wrap; }
        .fmt-btn { background: #3f3f46; border: none; color: #fff; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; min-width: 30px; transition: 0.2s; }
        .fmt-btn:hover { background: var(--primary); }
        .editor-content { flex: 1; background: #000; border: 1px solid var(--border); border-radius: 8px; padding: 20px; overflow-y: auto; text-align: left; line-height: 1.6; color: #d4d4d8; outline: none; font-size: 1rem; }
        .editor-content ul { padding-left: 20px; }
        .editor-content b { color: #fff; }

        /* GRAPH MODAL SPECIFIC */
        #goalStatsModal .sync-modal { max-width: 700px; width: 95%; height: auto; max-height: 90vh; overflow-y: auto; }
        
        .graph-wrapper { width: 100%; background: #202022; border-radius: 12px; padding: 10px 10px 40px 40px; position: relative; height: 300px; border: 1px solid #333; margin-bottom: 20px; }
        .graph-svg { width: 100%; height: 100%; overflow: visible; }
        
        /* Graph Tooltip */
        .graph-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--border);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transform: translate(-50%, -150%);
        }
        .graph-tooltip.visible { opacity: 1; }

        .axis-text { fill: #71717a; font-size: 10px; font-family: monospace; }
        .grid-line { stroke: #333; stroke-width: 1; stroke-dasharray: 4; }
        .data-line { fill: none; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; transition: all 0.3s; }
        .data-dot { transition: r 0.2s, stroke-width 0.2s; cursor: crosshair; }
        .data-dot:hover { r: 6; stroke: #fff; stroke-width: 2px; }
        
        /* Legend */
        .legend-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 15px; width: 100%; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #a1a1aa; cursor: pointer; user-select: none; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

        /* Collapsible Inputs */
        .input-toggle { width: 100%; text-align: center; padding: 12px; background: #27272a; color: #fff; font-size: 0.8rem; cursor: pointer; border-radius: 8px; margin-bottom: 5px; user-select: none; display: flex; justify-content: center; align-items: center; gap: 10px; font-weight: bold; }
        .collapsible-content { display: none; flex-direction: column; gap: 15px; background: #111; padding: 20px; border-radius: 0 0 8px 8px; border: 1px solid #27272a; border-top: none; margin-bottom: 15px; width: 100%; }
        .collapsible-content.show { display: flex; }

        /* Manage Variables UI */
        .variable-row { display: flex; gap: 10px; align-items: center; width: 100%; }
        .color-picker { width: 35px; height: 35px; border: none; background: none; cursor: pointer; padding: 0; }
        .color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker::-webkit-color-swatch { border: 1px solid #333; border-radius: 50%; }
        
        /* GREEN X for Variables */
        .var-del-btn { color: var(--success); font-weight: bold; cursor: pointer; padding: 5px 10px; border: 1px solid transparent; border-radius: 4px; transition: 0.2s; font-size: 1.1rem; }
        .var-del-btn:hover { background: rgba(34, 197, 94, 0.1); border-color: var(--success); transform: scale(1.1); }

        /* History List UI */
        .history-row { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; border-bottom: 1px solid #222; padding: 8px 0; }
        .history-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .history-input { background: #000; border: 1px solid #333; color: #fff; padding: 4px; border-radius: 4px; text-align: center; font-size: 0.75rem; outline: none; }
        .history-del-btn { color: var(--success); font-weight: bold; cursor: pointer; padding: 4px 8px; margin-left: auto; font-size: 1rem; transition: 0.2s; }
        .history-del-btn:hover { transform: scale(1.2); text-shadow: 0 0 5px var(--success); }

        .section-header { font-size: 0.7rem; color: #71717a; text-transform: uppercase; letter-spacing: 1px; width: 100%; text-align: left; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }

        .series-select { width: 100%; background: #000; color: #fff; border: 1px solid #333; padding: 10px; border-radius: 6px; outline: none; }

        .sync-modal { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 40px 30px; width: 90%; max-width: 400px; position: relative; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; }
        
        .modal-close { position: absolute; top: 20px; right: 20px; color: var(--success); cursor: pointer; font-weight: bold; font-size: 1.4rem; transition: 0.2s; }
        .modal-close:hover { transform: scale(1.1); }
        
        .modal-text { color: #a1a1aa; font-size: 0.9rem; margin-bottom: 25px; line-height: 1.6; text-align: center; }
        .modal-btns { display: flex; flex-direction: column; gap: 12px; width: 100%; }

        .custom-input { width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; outline: none; margin-bottom: 0; text-align: center; }
        
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .confirm-btn { background: var(--primary); color: white; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .confirm-btn:hover { opacity: 0.9; }
        
        /* Alarm Modal Specifics */
        .alarm-title { font-size: 2rem; font-weight: 800; color: var(--frog); margin-bottom: 10px; animation: pulseText 1s infinite; }
        @keyframes pulseText { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(0.95); } }

        /* Routine List */
        .routine-list { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; max-height: 350px; overflow-y: auto; }
        .routine-item { display: flex; justify-content: space-between; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; font-size: 0.8rem; align-items: center; }
        
        .routine-icon-group { display: flex; gap: 12px; align-items: center; }
        .routine-action.bolt { color: #facc15; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .routine-action.bolt:hover { transform: scale(1.2); color: #fff; }
        .routine-action.del { color: var(--primary); cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: 0.2s; }
        .routine-action.del:hover { transform: scale(1.2); color: #fff; }

        /* Main UI */
        .today-section { text-align: center; margin-top: 40px; }
        
        .quote-wrapper { position: relative; display: inline-block; max-width: 600px; min-height: 3em; margin-bottom: 20px; }
        .quote-text { font-size: 1.1rem; color: #a1a1aa; font-style: italic; cursor: help; transition: color 0.3s; }
        .quote-text:hover { color: #fff; }
        .quote-text:hover::after { content: attr(data-author); position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 10px; padding: 6px 12px; background: #000; border: 1px solid var(--primary); color: var(--primary); font-size: 0.8rem; border-radius: 6px; white-space: nowrap; font-style: normal; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100; }

        .main-percent { font-size: 6rem; font-weight: 800; color: var(--primary); line-height: 1; transition: 0.5s; }
        .main-percent.complete { color: var(--success); text-shadow: 0 0 30px rgba(34, 197, 94, 0.6); transform: scale(1.1); }
        .label { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; color: #71717a; font-weight: 600; margin-top: 10px; }

        .input-group { width: 100%; max-width: 500px; margin: 30px auto; display: flex; flex-direction: column; gap: 10px; }
        input { width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 18px; border-radius: 14px; box-sizing: border-box; outline: none; font-size: 1rem; text-align: center; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: #050505; }
        #frogInput { border-color: var(--frog); }

        @keyframes frogGlow { 0% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.1); } 50% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.25); } 100% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.1); } }
        .habit-item.is-frog:not(.done) { animation: frogGlow 3s infinite ease-in-out; }

        .board { display: flex; justify-content: center; gap: 15px; width: 100%; margin-bottom: 50px; align-items: flex-start; flex-wrap: wrap; }
        .column { flex: 1; min-width: 300px; max-width: 320px; border-radius: 16px; padding: 5px; min-height: 100px; }
        
        .habit-item { background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 12px; transition: 0.2s; position: relative; cursor: grab; }
        .habit-item:active { cursor: grabbing; }
        .habit-item.dragging { opacity: 0.4; border: 1px dashed var(--text); background: #000; }
        .habit-item.is-frog { border: 1px solid var(--frog); background: linear-gradient(145deg, #18181b, #1e1b12); }
        .habit-item.done { opacity: 0.4; border-left: 4px solid var(--primary); }
        .habit-item.is-frog.done { border-left: 4px solid var(--frog); opacity: 0.6; }
        
        .habit-row { display: flex; justify-content: space-between; align-items: center; pointer-events: none; }
        .habit-row > * { pointer-events: auto; }

        .check { width: 24px; height: 24px; border: 2px solid #3f3f3f; border-radius: 7px; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .done .check { background: var(--primary); border-color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .is-frog.done .check { background: var(--frog); border-color: var(--frog); }
        .done .check::after { content: '‚úì'; color: white; font-weight: bold; font-size: 14px; }
        
        .action-btns { display: flex; gap: 8px; align-items: center; }
        .move-btn { color: var(--primary); cursor: pointer; font-size: 1.1rem; font-weight: bold; display: none; }
        .pen-btn { color: #a1a1aa; cursor: pointer; font-size: 1rem; transition: 0.2s; } .pen-btn:hover { color: #fff; }
        .routine-btn { color: #facc15; cursor: pointer; font-size: 1rem; transition: 0.2s; } .routine-btn:hover { color: #fff; transform: scale(1.1); }
        .delete-btn { color: var(--success); opacity: 0.8; cursor: pointer; font-size: 1.1rem; transition: 0.2s; min-width: 18px; text-align: center; } .delete-btn:hover { opacity: 1; }
        .delete-btn.confirm { color: var(--success); font-weight: bold; opacity: 1; }

        /* --- COLUMN SELECTOR SQUARES --- */
        .col-selector-wrap { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; pointer-events: auto; }
        .sq-btn { width: 16px; height: 16px; border: 1px solid #3f3f46; border-radius: 4px; cursor: pointer; transition: 0.2s; background: transparent; }
        .sq-btn:hover { border-color: var(--text); transform: scale(1.1); }
        .sq-btn.active { background: var(--primary); border-color: var(--primary); }
        .is-frog .sq-btn.active { background: var(--frog); border-color: var(--frog); }

        .year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; border-top: 1px solid var(--border); padding-top: 60px; width: 100%; }
        .month-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
        .month-title { display: flex; justify-content: space-between; font-size: 0.6rem; color: #a1a1aa; margin-bottom: 8px; text-transform: uppercase; align-items: center; }
        .month-name-btn { cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .month-name-btn:hover { color: var(--primary); text-decoration: underline; }
        
        .month-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-sq { width: 100%; aspect-ratio: 1; background: rgba(255, 255, 255, 0.05); border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; position: relative; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.2s; }
        .day-sq:hover { transform: scale(1.5); z-index: 100; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); border: 1px solid var(--text); }
        .day-sq:hover::after { content: attr(data-pct); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid var(--primary); color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; white-space: nowrap; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 200; }

        .trophy-section { width: 100%; display: flex; justify-content: center; align-items: center; gap: 30px; margin: 40px 0; }
        .trophy-btn { font-size: 3rem; cursor: pointer; opacity: 0.3; transition: all 0.3s; user-select: none; }
        .trophy-btn:hover { opacity: 0.8; transform: scale(1.5); text-shadow: 0 0 15px #ffd700; filter: drop-shadow(0 0 6px #ffd700); }
        .action-icon { font-size: 1.8rem; cursor: pointer; opacity: 0.4; transition: all 0.3s; }
        .action-icon:hover { opacity: 1; transform: scale(1.2); }
        .bolt-btn { color: #facc15; } .broom-btn { color: #a1a1aa; } .broom-btn:hover { color: #fff; }

        /* GOALS LAYOUT: FLEX - 3 COLUMNS */
        .goals-flex { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; max-width: 1000px; padding-bottom: 20px; }
        
        .goal-card { 
            flex: 0 0 calc(33.333% - 10px);
            min-width: 0; 
            background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; 
            display: flex; flex-direction: column; gap: 10px; position: relative; min-height: 100px; 
        }
        
        @media (max-width: 800px) { .year-grid { grid-template-columns: repeat(2, 1fr); } }
        
        @media (max-width: 600px) { 
            .goal-card { flex: 0 0 100%; } 
            
            /* MOBILE BUTTON COLORS override */
            .mobile-blue { border-color: var(--primary) !important; color: var(--primary) !important; }
        }

        .goal-card.done { border-color: var(--success); opacity: 0.7; }
        
        .add-ms-header-btn { width: 14px; height: 14px; border: 1px solid var(--milestone); border-radius: 3px; background: transparent; cursor: pointer; transition: 0.2s; }
        .add-ms-header-btn:hover { background: var(--milestone); transform: scale(1.25); }

        .milestone-list { display: flex; flex-direction: column; gap: 6px; width: 100%; align-items: center; min-height: 20px; }
        .milestone-box { width: 90%; background: #27272a; border: 1px solid #3f3f46; border-radius: 6px; padding: 6px 8px; font-size: 0.7rem; color: #a1a1aa; text-align: center; cursor: pointer; user-select: none; position: relative; white-space: normal; word-wrap: break-word; transition: 0.2s; }
        .milestone-box:hover { color: #fff; border-color: var(--text); z-index: 5; }
        .milestone-box.done { background: var(--success); color: #000; border-color: var(--success); font-weight: bold; opacity: 1; }
        .milestone-box.dragging { opacity: 0.2; background: var(--milestone); }
        
        /* FIXED MS-DEL */
        .ms-del { position: absolute; top: 50%; right: 5px; transform: translateY(-50%); color: var(--primary); cursor: pointer; font-size: 0.8rem; font-weight: bold; opacity: 0; transition: 0.2s; z-index: 6; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        .milestone-box:hover .ms-del { opacity: 1; } .ms-del:hover { transform: translateY(-50%) scale(1.2); } .ms-del.confirm { color: var(--success); }

        .nav-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; margin: 40px auto; padding-top: 20px; border-top: 1px solid var(--border); }
        .nav-btn { background: none; border: 1px solid var(--border); color: var(--text); padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .nav-btn:hover { background: var(--card); }
        .current-date-display { font-weight: 800; color: var(--primary); cursor: pointer; }

        .footer-tools { margin-top: auto; padding: 40px 0; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; position: relative; z-index: 2001; }
        .timer-row { display: flex; gap: 15px; align-items: center; }
        .timer-btn { font-family: monospace; font-size: 1.2rem; color: var(--success); font-weight: bold; cursor: pointer; padding: 10px 20px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; user-select: none; transition: 0.3s; min-width: 80px; text-align: center; }
        .timer-btn:hover { background: rgba(34, 197, 94, 0.1); transform: translateY(-2px); }
        .timer-btn.active { animation: breathe 3s infinite; border-color: var(--success); background: rgba(34, 197, 94, 0.2); }
        .timer-btn.paused { animation: none; opacity: 0.5; border-style: dashed; }
        #timerCustom { color: var(--primary); border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        #timerCustom:hover { background: rgba(59, 130, 246, 0.1); }
        #timerCustom.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.2); }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.98); } }

        #frogCounter { font-size: 0.6rem; color: var(--success); opacity: 0.4; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        .button-row { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .tool-btn { text-decoration: none; color: #a1a1aa; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; padding: 12px 24px; border: 1px solid #27272a; border-radius: 30px; transition: 0.3s; font-weight: bold; background: none; cursor: pointer; }
        .tool-btn:hover { background: #fff; color: #000; border-color: #fff; transform: translateY(-2px); }
        .tool-btn.active-listen { background: rgba(34, 197, 94, 0.1); border-color: var(--success); color: var(--success); box-shadow: 0 0 10px rgba(34,197,94,0.3); }

        .toggle-section { width: 100%; max-width: 500px; text-align: center; }
        .toggle-link { background: none; border: none; color: #71717a; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; opacity: 0.4; transition: 0.3s; }
        .toggle-link:hover { opacity: 1; }
        .expand-box { height: 0; overflow: hidden; opacity: 0; transition: all 0.4s ease-in-out; text-align: center; }
        .expand-box.open { height: auto; opacity: 1; padding: 20px 0; }
        .instruction-box { background: rgba(17, 17, 17, 0.5); border: 1px solid rgba(39, 39, 42, 0.3); padding: 25px; border-radius: 15px; font-size: 0.75rem; color: #71717a; line-height: 1.6; }

        #syncPulse { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: var(--success); margin-left: 5px; opacity: 0; }
        .pulsing { animation: pulseDot 2s infinite; opacity: 1 !important; }
        @keyframes pulseDot { 0% { transform: scale(0.95); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.95); opacity: 0.5; } }

        /* HEARTBEAT ANIMATIONS */
        .blink-blue { animation: textBlinkBlue 1s infinite; color: var(--primary) !important; font-weight: bold; }
        @keyframes textBlinkBlue { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .blink-yellow { animation: textBlinkYellow 1s infinite; color: var(--frog) !important; font-weight: bold; }
        @keyframes textBlinkYellow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="focus-overlay"></div>
<div id="firework-container" class="firework-container"></div>
<div id="toast" class="toast"></div>

<div id="syncModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeSyncModal()">‚úï</div>
        <div class="modal-text">Cloud Sync</div>
        <div class="modal-btns">
            <button onclick="cloudSync('download'); closeSyncModal()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Download</button>
            <button onclick="cloudSync('upload'); closeSyncModal()" class="tool-btn" style="border-color: var(--success); color: var(--success);">Upload</button>
            <hr style="width:50%; border:0; border-top:1px solid #333; margin:10px auto;">
            <button onclick="sendRemoteSignal(); closeSyncModal()" class="tool-btn" style="border-color: var(--frog); color: var(--frog);">Signal Remote Upload</button>
        </div>
    </div>
</div>

<div id="alarmModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="alarm-title">Timer Ended</div>
        <div class="modal-text">Frog time is over. Take a breath.</div>
        <button onclick="stopAlarmLoop()" class="confirm-btn">Okay</button>
    </div>
</div>

<div id="newDataModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="alarm-title" style="color:var(--success)">Success!</div>
        <div class="modal-text">Remote Device Uploaded New Data.<br>Download it now?</div>
        <button onclick="cloudSync('download'); document.getElementById('newDataModal').style.display='none'" class="confirm-btn">Download Now</button>
    </div>
</div>

<div id="uploadingModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="alarm-title" style="color:var(--frog)">Signal Received</div>
        <div class="modal-text">Remote requested upload.<br>Uploading data now...</div>
    </div>
</div>

<div id="goalInputModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeGoalModal()">‚úï</div>
        <div class="modal-text" style="font-size: 1.1rem; font-weight: bold;">Enter a longterm goal</div>
        <input type="text" id="newGoalText" class="custom-input" placeholder="e.g. Run a Marathon">
        <button onclick="confirmAddGoal()" class="confirm-btn">OK</button>
    </div>
</div>

<div id="milestoneInputModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeMilestoneModal()">‚úï</div>
        <div class="modal-text" style="font-size: 1.1rem; font-weight: bold;">Add Milestone</div>
        <input type="text" id="newMilestoneText" class="custom-input" placeholder="e.g. Read Chapter 1">
        <button onclick="confirmAddMilestone()" class="confirm-btn">Add</button>
    </div>
</div>

<div id="richTextModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeRichTextModal()">‚úï</div>
        <div class="modal-text" id="richTextTitle">Notes</div>
        
        <div class="editor-wrapper">
            <div class="editor-toolbar">
                <button class="fmt-btn" onclick="fmt('bold')" title="Bold"><b>B</b></button>
                <button class="fmt-btn" onclick="fmt('italic')" title="Italic"><i>I</i></button>
                <button class="fmt-btn" onclick="fmt('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                <div style="width:1px; background:#3f3f46; margin:0 5px;"></div>
                <button class="fmt-btn" onclick="fmt('justifyLeft')" title="Align Left">‚áê</button>
                <button class="fmt-btn" onclick="fmt('justifyCenter')" title="Align Center">=</button>
                <button class="fmt-btn" onclick="fmt('justifyRight')" title="Align Right">‚áí</button>
            </div>
            <div id="richEditor" class="editor-content" contenteditable="true"></div>
        </div>
        
        <button onclick="saveRichText()" class="confirm-btn">Save Notes</button>
    </div>
</div>

<div id="goalStatsModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeStatsModal()">‚úï</div>
        <div class="modal-text" id="statsTitle" style="font-weight:bold; color:#fff; margin-bottom:10px;">Goal Stats</div>
        
        <div class="graph-wrapper">
            <svg id="graphSvg" class="graph-svg"></svg>
            <div id="graphTooltip" class="graph-tooltip"></div>
        </div>

        <div id="graphLegend" class="legend-container"></div>

        <div class="input-toggle" onclick="toggleCollapse('manageDataSection')">
            Manage Data & Variables <span>‚ñº</span>
        </div>
        
        <div id="manageDataSection" class="collapsible-content">
            
            <div id="variableListContainer" style="width:100%; display:flex; flex-direction:column; gap:10px;"></div>
            
            <button id="createVarBtn" onclick="createVariable()" class="confirm-btn" style="width:100%; background:#27272a; border:1px solid #3f3f46;">+ Add New Variable</button>

            <hr style="width:100%; border:0; border-top:1px solid #333; margin:10px 0;">

            <div id="dataEntryContainer" style="display:none; width:100%; flex-direction:column; gap:10px;">
                <div class="section-header">Add Data Entry</div>
                <select id="seriesSelect" class="series-select"></select>
                <div style="display:flex; gap:10px; width:100%;">
                    <input type="number" id="statValue" class="custom-input" style="flex:1; margin-bottom:0;" placeholder="Value">
                    <input type="date" id="statDate" class="custom-input" style="flex:1; margin-bottom:0; font-family:sans-serif;">
                </div>
                <button onclick="addStat()" class="confirm-btn" style="width:100%;">Add Entry</button>
            </div>
            
            <div id="noVarsMsg" style="color:#555; font-size:0.8rem;">Create a variable above to add data.</div>

        </div>

        <div class="input-toggle" onclick="toggleCollapse('editHistorySection')">
            Edit Data Points <span>‚ñº</span>
        </div>
        <div id="editHistorySection" class="collapsible-content">
            <div id="dataHistoryContent" style="width:100%; display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>
</div>

<div id="goalRoutineModal" class="modal-overlay">
    <div class="sync-modal" style="max-width: 400px;">
        <div class="modal-close" onclick="closeRoutineModal()">‚úï</div>
        <div class="modal-text">Goal Routine</div>
        <div class="routine-list" id="routineList"></div>
        <input type="text" id="newRoutineTask" class="custom-input" placeholder="New task (e.g. Hangboard)" onkeypress="if(event.key==='Enter') addRoutineTask()">
        <button onclick="addAllRoutinesToToday()" class="confirm-btn">Add All to Today</button>
    </div>
</div>

<div id="dailyRoutineModal" class="modal-overlay">
    <div class="sync-modal" style="max-width: 400px;">
        <div class="modal-close" onclick="closeDailyRoutineModal()">‚úï</div>
        <div class="modal-text">Daily Routine</div>
        <div class="routine-list" id="dailyRoutineList"></div>
        <input type="text" id="newDailyRoutineTask" class="custom-input" placeholder="(e.g. take a hike)" onkeypress="if(event.key==='Enter') addDailyRoutineTask()">
        <button onclick="addAllDailyRoutinesToToday()" class="confirm-btn">Add All to Today</button>
    </div>
</div>

<div id="customTimerModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeCustomTimerModal()">‚úï</div>
        <div class="modal-text" style="font-size: 1.1rem; font-weight: bold;">Set Timer Duration</div>
        <input type="number" id="customTimerInput" class="custom-input" placeholder="Minutes (e.g. 45)" onkeypress="if(event.key==='Enter') confirmCustomTimer()">
        <button onclick="confirmCustomTimer()" class="confirm-btn">Start</button>
    </div>
</div>

<div class="container">
    <div class="today-section">
        <div class="quote-wrapper">
            <span class="quote-text" id="quoteText" data-author=""></span>
        </div>
        <div class="label" id="frogLabel">Today's Frog</div>
        <div class="main-percent" id="mainPercent">0%</div>
    </div>

    <div class="input-group">
        <input type="text" id="frogInput" placeholder="Set today's BIG FROG (one per day)...">
        <input type="text" id="habitInput" placeholder="Add another task...">
    </div>

    <div class="board">
        <div class="column" id="col-0" data-col="0"></div>
        <div class="column" id="col-1" data-col="1"></div>
        <div class="column" id="col-2" data-col="2"></div>
    </div>

    <div class="year-grid" id="yearGrid"></div>

    <div class="trophy-section">
        <div class="action-icon bolt-btn" onclick="openDailyRoutineModal()" title="Daily Routine">‚ö°</div>
        <div class="trophy-btn" onclick="openGoalModal()" title="Goals">üèÜ</div>
        <div class="action-icon broom-btn" onclick="sweepIncompleteTasks()" title="Sweep to Tomorrow">üßπ</div>
    </div>
    
    <div class="goals-flex" id="goalsGrid"></div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="changeDate(-1)">‚Üê Yesterday</button>
        <div class="current-date-display" id="dateDisplay" onclick="jumpToToday()">Date</div>
        <button class="nav-btn" onclick="changeDate(1)">Tomorrow ‚Üí</button>
    </div>

    <div class="footer-tools">
        <div class="timer-row">
            <div class="timer-btn" id="timer25" onclick="handleTimerClick(25, 'timer25')" ondblclick="resetTimer('timer25', 25)">25:00</div>
            <div class="timer-btn" id="timerCustom" onclick="openCustomTimerModal()" ondblclick="resetTimer('timerCustom', 'Custom')">Custom</div>
            <div class="timer-btn" id="timer5" onclick="handleTimerClick(5, 'timer5')" ondblclick="resetTimer('timer5', 5)">05:00</div>
        </div>

        <div style="display:flex; align-items:center; gap:5px; flex-direction: column;">
            <div style="display:flex; align-items:center; gap:5px;">
                <div id="syncStatus" style="font-size: 0.6rem; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Cloud: Unlinked</div>
                <div id="syncPulse"></div>
            </div>
            <div id="debugBinId" style="font-size: 0.5rem; color: #3f3f46; margin-top: 2px;">ID: None</div>
            
            <div class="toggle-section" style="width: 100%; margin-top: 5px;">
                <button class="toggle-link" onclick="toggleElement('syncHistoryBox', 'Sync History')" style="font-size: 0.55rem;">Show Sync History ‚Üì</button>
                <div id="syncHistoryBox" class="expand-box">
                    <div class="instruction-box" id="syncHistoryList" style="text-align: left; font-family: monospace; font-size: 0.65rem; max-height: 150px; overflow-y: auto; color: #a1a1aa; padding: 15px;">
                        <div style="opacity: 0.5; text-align: center;">No actions logged yet.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="button-row" style="margin-top:10px;">
            <button onclick="openSyncModal()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Sync</button>
            <button onclick="setupCloud()" class="tool-btn mobile-blue" style="border-color: var(--success); color: var(--success);">Link</button>
            <button onclick="resetCloud()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Reset</button>
        </div>

        <div class="button-row">
            <button onclick="playStretch()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Stretch</button>
            <button onclick="playChillVibe()" class="tool-btn mobile-blue" style="border-color: var(--success); color: var(--success);">Chill</button>
            <a href="https://www.brain.fm" target="_blank" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Meditate</a>
        </div>

        <div id="frogCounter">0 Frogs Eaten</div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('setupGuide', 'Setup Guide')">Show Setup Guide ‚Üì</button>
            <div id="setupGuide" class="expand-box">
                <div class="instruction-box">
                    <b>CLOUDSYNC SETUP</b><br>
                    1. Get a Master Key from JSONBin.io.<br>
                    2. Click "Link" (Green) to enter your Key.<br>
                    3. Click "Sync" then "Upload" to create your first locker.<br>
                    4. Save the generated ID to link other devices!<br>
                    5. Ensure that the ID: Under Cloud Ready is the same on both devices
                </div>
            </div>
        </div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('howToUse', 'How To Use')">Show How To Use ‚Üì</button>
            <div id="howToUse" class="expand-box">
                <div class="instruction-box" style="text-align: left;">
                    <strong style="color:var(--primary)">üê∏ THE PHILOSOPHY</strong><br>
                    "Eat the Frog" means doing your hardest, most important task first. That is your <b>Frog</b>. Put it in the top yellow box. It glows until it's done.<br><br>
                    
                    <strong style="color:var(--primary)">üìù DAILY TASKS</strong><br>
                    Add other tasks below. Use the squares to move them between columns (To Do, Doing, Done) (Organized by catagory) (Or just how you're feeling).<br><br>
                    
                    <strong style="color:#facc15">üèÜ GOALS</strong><br>
                    Goals are persistent. Unlike daily tasks, they stay until deleted. Create milestones or set a 'Goal Routine' to quickly add related tasks to your day.<br><br>

                    <strong style="color:#facc15">‚ö° DAILY ROUTINE</strong><br>
                    Click the Lightning Bolt next to the Trophy to manage your daily recurring tasks.<br><br>

                    <strong style="color:#fff">üßπ SWEEP</strong><br>
                    Click the Broom to move all incomplete tasks to tomorrow.<br><br>
                    
                    <strong style="color:var(--success)">‚è≥ TIMERS</strong><br>
                    Single-click to Start/Pause. Double-click to Reset.<br>
                    When timer ends, click "Okay" on the popup to stop the sound.<br><br>

                    <strong style="color:var(--success)">‚òÅÔ∏è LINK & SYNC</strong><br>
                    Follow the setup guide to link a JSONBin.io account to your task tracker.<br>
                    Download, Upload, Remotely or from the original device<br>
                    Keeping all your devices synced with the same tasks and goals.
                </div>
            </div>
        </div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('dangerZone', 'Danger Zone')">Danger Zone ‚Üì</button>
            <div id="dangerZone" class="expand-box">
                <button onclick="clearAllData()" class="tool-btn" style="color: #ef4444; border-color: #ef4444; margin-top: 10px; font-size: 0.5rem; opacity: 0.4;">Wipe All History</button>
                <button onclick="resetCloud()" class="tool-btn" style="color: #ef4444; border-color: #ef4444; margin-top: 10px; font-size: 0.5rem; opacity: 0.4;">Unlink Cloud</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Quote Data ---
    const markTwainQuote = { text: "If it's your job to eat a frog, it's best to do it first thing in the morning. And If it's your job to eat two frogs, it's best to eat the biggest one first.", author: "Mark Twain" };
    const quotesList = [
        { text: "You do not rise to the level of your goals. You fall to the level of your systems.", author: "James Clear" },
        { text: "A year from now you may wish you had started today.", author: "Karen Lamb" },
        { text: "Start before you are ready.", author: "Steven Pressfield" },
        { text: "Long-term consistency trumps short-term intensity.", author: "Bruce Lee" },
        { text: "It is not that we have a short time to live, but that we waste a lot of it.", author: "Seneca" },
        { text: "Action is the foundational key to all success.", author: "Pablo Picasso" },
        { text: "Do what you can, with what you have, where you are.", author: "Theodore Roosevelt" },
        { text: "You have power over your mind - not outside events. Realize this, and you will find strength.", author: "Marcus Aurelius" },
        { text: "The man who moves a mountain begins by carrying away small stones.", author: "Confucius" },
        { text: "I have been impressed with the urgency of doing. Knowing is not enough; we must apply.", author: "Leonardo da Vinci" },
        { text: "Give me six hours to chop down a tree and I will spend the first four sharpening the axe.", author: "Abraham Lincoln" },
        { text: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
        { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
        { text: "First say to yourself what you would be; and then do what you have to do.", author: "Epictetus" },
        { text: "I‚Äôm a greater believer in luck, and I find the harder I work the more I have of it.", author: "Thomas Jefferson" },
        { text: "The beginning is the most important part of the work.", author: "Plato" },
        { text: "Opportunities multiply as they are seized.", author: "Sun Tzu" },
        { text: "The secret of change is to focus all of your energy, not on fighting the old, but on building the new.", author: "Socrates" },
        { text: "Don't wait. The time will never be just right.", author: "Napoleon Hill" },
        markTwainQuote 
    ];

    // --- Victory Messages ---
    const firstVictoryQuote = "The frog is eaten. The day is won.";
    const randomVictoryQuotes = [
        "Rest easy. You have earned it.",
        "A day well spent brings happy sleep.",
        "The standard has been set.",
        "Chaos conquered.",
        "Consistency is the only magic.",
        "No regrets today.",
        "Momentum is built one day at a time.",
        "The Pain of growth is far less than the pain of regret.", 
        "Tomorrow starts with the victory of today.",
        "You are what you repeatedly do.",
        "Sleep the sleep of the just.",
        "Another brick laid. Another step taken.",
        "The mind commands, the body obeys.",
        "Respect yourself. You kept your word.",
        "Sharpen the axe. Rest now.",
        "This is what progress feels like."
    ];
    
    let state = JSON.parse(localStorage.getItem('discipline_v12')) || { dailyData: {} };
    if (!state.longTermGoals || !Array.isArray(state.longTermGoals)) state.longTermGoals = []; 
    if (!state.dailyRoutine) state.dailyRoutine = [];
    if (!state.monthNotes) state.monthNotes = {}; // New storage for month notes

    // --- UNIQUE DEVICE ID ---
    const DEVICE_ID = 'dev-' + Math.random().toString(36).substr(2, 9);

    let viewingDate = new Date();
    // Timer State 
    let activeTimer = { id: null, totalSeconds: 0, interval: null, isPaused: false };
    let audioCtx;
    let alarmLoopInterval = null;
    let remoteListenInterval = null;
    let isIntentionallyPaused = false; 
    
    let deleteTimeouts = {};
    let CLOUD_CONFIG = { key: localStorage.getItem('sync_key') || '', binId: localStorage.getItem('sync_bin_id') || '' };
    let activeGoalId = null;
    let currentGoalIdForMilestone = null;
    let activeRichContext = null; // 'goal' or 'month'
    let activeRichId = null;
    let pollInterval = null; 

    // --- Logger Logic ---
    function addSyncLog(msg) {
        const list = document.getElementById('syncHistoryList');
        if (!list) return;
        
        if (list.innerHTML.includes("No actions logged yet")) list.innerHTML = '';

        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        const logItem = document.createElement('div');
        logItem.innerHTML = `<span style="color:var(--primary)">[${time}]</span> ${msg}`;
        logItem.style.marginBottom = '6px';
        logItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
        logItem.style.paddingBottom = '4px';
        
        list.prepend(logItem); 
        
        if (list.children.length > 20) {
            list.removeChild(list.lastChild); 
        }
    }

    // --- Toast Logic ---
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // --- Modal Logic ---
    function openSyncModal() { document.getElementById('syncModal').style.display = 'flex'; }
    function closeSyncModal() { document.getElementById('syncModal').style.display = 'none'; }

    function openGoalModal() { document.getElementById('goalInputModal').style.display = 'flex'; document.getElementById('newGoalText').focus(); }
    function closeGoalModal() { document.getElementById('goalInputModal').style.display = 'none'; document.getElementById('newGoalText').value = ''; }

    // --- RICH TEXT EDITOR LOGIC ---
    function openRichTextModal(context, id) {
        activeRichContext = context;
        activeRichId = id;
        
        const titleEl = document.getElementById('richTextTitle');
        const editor = document.getElementById('richEditor');
        
        if(context === 'goal') {
            const goal = state.longTermGoals.find(g => g.id === id);
            titleEl.innerText = `Goal Notes: ${goal.text}`;
            editor.innerHTML = goal.notes || '';
        } else if (context === 'month') {
            const [y, m] = id.split('-'); // 2026-0
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            titleEl.innerText = `${monthNames[parseInt(m)]} ${y} Notes`;
            editor.innerHTML = state.monthNotes[id] || '';
        }

        document.getElementById('richTextModal').style.display = 'flex';
        editor.focus();
    }

    function closeRichTextModal() { 
        document.getElementById('richTextModal').style.display = 'none'; 
        activeRichContext = null; 
        activeRichId = null; 
    }

    function fmt(command, value = null) {
        document.execCommand(command, false, value);
        document.getElementById('richEditor').focus();
    }

    function saveRichText() {
        const content = document.getElementById('richEditor').innerHTML;
        
        if(activeRichContext === 'goal') {
            state.longTermGoals = state.longTermGoals.map(g => g.id === activeRichId ? { ...g, notes: content } : g);
        } else if (activeRichContext === 'month') {
            if(!state.monthNotes) state.monthNotes = {};
            state.monthNotes[activeRichId] = content;
        }
        
        saveAndRender();
        closeRichTextModal();
        showToast("Notes saved.");
    }
    
    // Wrapper for old calls
    function openNotesModal(id) { openRichTextModal('goal', id); }
    function closeNotesModal() { closeRichTextModal(); } // Just in case

    function openMilestoneModal(id) {
        currentGoalIdForMilestone = id;
        document.getElementById('milestoneInputModal').style.display = 'flex';
        document.getElementById('newMilestoneText').focus();
    }
    function closeMilestoneModal() {
        document.getElementById('milestoneInputModal').style.display = 'none';
        document.getElementById('newMilestoneText').value = '';
        currentGoalIdForMilestone = null;
    }
    function confirmAddMilestone() {
        const text = document.getElementById('newMilestoneText').value;
        if (text && currentGoalIdForMilestone) {
            const goal = state.longTermGoals.find(g => g.id === currentGoalIdForMilestone);
            if (goal) { 
                goal.milestones.push({ id: Date.now(), text: text, done: false });
                saveAndRender();
                closeMilestoneModal();
            }
        }
    }
    document.getElementById('newMilestoneText').addEventListener('keypress', e => e.key === 'Enter' && confirmAddMilestone());

    // --- MULTI-LINE GRAPH LOGIC ---
    const DEFAULT_COLORS = ['#f472b6', '#facc15', '#60a5fa', '#c084fc'];

    function toggleCollapse(id) {
        const el = document.getElementById(id);
        el.classList.toggle('show');
    }

    function openStatsModal(id) {
        activeGoalId = id;
        document.getElementById('goalStatsModal').style.display = 'flex';
        // Default date to today
        document.getElementById('statDate').valueAsDate = new Date();
        document.getElementById('statValue').value = '';
        
        // Populate inputs with goal data
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        
        // Ensure data structure exists
        if(!goal.datasets) {
             if(goal.stats) {
                 // Migrate old data
                 goal.datasets = [{ label: "Variable 1", color: DEFAULT_COLORS[0], data: goal.stats }];
                 delete goal.stats;
             } else {
                 goal.datasets = [];
             }
        }
        // Patch for old datasets lacking color
        goal.datasets.forEach((ds, i) => {
            if(!ds.color) ds.color = DEFAULT_COLORS[i % 4];
        });

        renderMultiGraph();
        renderManageSection();
        renderDataHistory();
    }
    
    function closeStatsModal() { document.getElementById('goalStatsModal').style.display = 'none'; activeGoalId = null; }

    // Render the list of existing variables and the add button
    function renderManageSection() {
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        const container = document.getElementById('variableListContainer');
        container.innerHTML = '';

        if(goal.datasets.length > 0) {
            // Render existing variables
            goal.datasets.forEach((ds, i) => {
                const row = document.createElement('div');
                row.className = 'variable-row';
                row.innerHTML = `
                    <input type="color" class="color-picker" value="${ds.color}" onchange="updateVarColor(${i}, this.value)">
                    <input type="text" class="custom-input" style="margin:0; flex:1; text-align:left;" value="${ds.label}" onchange="updateVarName(${i}, this.value)">
                    <div class="var-del-btn" onclick="deleteVariable(${i})">‚úï</div>
                `;
                container.appendChild(row);
            });
            
            // Show Add Data Section
            document.getElementById('dataEntryContainer').style.display = 'flex';
            document.getElementById('noVarsMsg').style.display = 'none';
            updateSeriesSelectDropdown();
        } else {
            // Hide Add Data Section
            document.getElementById('dataEntryContainer').style.display = 'none';
            document.getElementById('noVarsMsg').style.display = 'block';
        }

        // Toggle Add Button
        const btn = document.getElementById('createVarBtn');
        if(goal.datasets.length >= 4) {
            btn.style.display = 'none';
        } else {
            btn.style.display = 'block';
        }
    }

    // Render Data Points List
    function renderDataHistory() {
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        const container = document.getElementById('dataHistoryContent');
        container.innerHTML = '';
        
        let hasData = false;
        
        // Iterate through all datasets
        goal.datasets.forEach((ds, sIdx) => {
            if(ds.data.length === 0) return;
            hasData = true;

            // Header for the Series
            const header = document.createElement('div');
            header.className = 'section-header';
            header.style.color = ds.color;
            header.style.marginTop = '10px';
            header.innerText = ds.label;
            container.appendChild(header);

            // Sort data by date (newest first for editing)
            const sortedData = [...ds.data].sort((a,b) => new Date(b.date) - new Date(a.date));

            sortedData.forEach(p => {
                const row = document.createElement('div');
                row.className = 'history-row';
                
                // We need the ORIGINAL index to delete properly, but id is safer
                row.innerHTML = `
                    <div class="history-dot" style="background:${ds.color}"></div>
                    <input type="date" class="history-input" style="width:110px;" value="${p.date}" onchange="updateDataPoint(${sIdx}, ${p.id}, 'date', this.value)">
                    <input type="number" class="history-input" style="width:70px;" value="${p.value}" onchange="updateDataPoint(${sIdx}, ${p.id}, 'value', this.value)">
                    <div class="history-del-btn" onclick="deleteDataPoint(${sIdx}, ${p.id})">‚úï</div>
                `;
                container.appendChild(row);
            });
        });

        if(!hasData) container.innerHTML = '<div style="color:#555; font-size:0.8rem; text-align:center;">No data points recorded yet.</div>';
    }

    function createVariable() {
        if(!activeGoalId) return;
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        if(goal.datasets.length >= 4) return;

        const newIdx = goal.datasets.length;
        goal.datasets.push({
            label: `New Variable`,
            color: DEFAULT_COLORS[newIdx],
            data: []
        });
        saveAndRender();
        renderManageSection();
        renderMultiGraph();
        renderDataHistory();
    }

    function deleteVariable(idx) {
        if(!activeGoalId) return;
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        
        // Prevent deleting the last variable
        if (goal.datasets.length <= 1) {
            showToast("Must have at least one variable.");
            return;
        }

        if(confirm(`Delete variable "${goal.datasets[idx].label}" and all its data?`)) {
            goal.datasets.splice(idx, 1);
            saveAndRender();
            renderManageSection();
            renderMultiGraph();
            renderDataHistory();
        }
    }

    function updateVarName(idx, val) {
        if(!activeGoalId) return;
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        goal.datasets[idx].label = val;
        saveAndRender();
        renderMultiGraph(); // Legend update
        renderDataHistory(); // Update headers
        updateSeriesSelectDropdown();
    }

    function updateVarColor(idx, val) {
        if(!activeGoalId) return;
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        goal.datasets[idx].color = val;
        saveAndRender();
        renderMultiGraph(); // Graph line color update
        renderManageSection(); // Update picker UI if needed
        renderDataHistory(); // Update dots
    }

    function updateSeriesSelectDropdown() {
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        const select = document.getElementById('seriesSelect');
        const currentVal = select.value;
        select.innerHTML = '';
        
        goal.datasets.forEach((ds, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = ds.label;
            select.appendChild(opt);
        });
        // Try to keep selection
        if(currentVal && currentVal < goal.datasets.length) select.value = currentVal;
    }

    function addStat() {
        const val = parseFloat(document.getElementById('statValue').value);
        const date = document.getElementById('statDate').value;
        const seriesIdx = parseInt(document.getElementById('seriesSelect').value);
        
        if(val && date && activeGoalId !== null && !isNaN(seriesIdx)) {
            const goal = state.longTermGoals.find(g => g.id === activeGoalId);
            
            goal.datasets[seriesIdx].data.push({ id: Date.now(), date: date, value: val });
            goal.datasets[seriesIdx].data.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            saveAndRender();
            renderMultiGraph();
            renderDataHistory();
            document.getElementById('statValue').value = '';
            showToast("Entry added.");
        }
    }

    function updateDataPoint(sIdx, pId, field, val) {
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        const point = goal.datasets[sIdx].data.find(p => p.id === pId);
        if(point) {
            if(field === 'value') point.value = parseFloat(val);
            if(field === 'date') point.date = val;
            
            // Re-sort in case date changed
            goal.datasets[sIdx].data.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            saveAndRender();
            renderMultiGraph();
        }
    }

    function deleteDataPoint(sIdx, pId) {
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        goal.datasets[sIdx].data = goal.datasets[sIdx].data.filter(p => p.id !== pId);
        saveAndRender();
        renderMultiGraph();
        renderDataHistory();
    }

    function renderMultiGraph() {
        if(!activeGoalId) return;
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        const svg = document.getElementById('graphSvg');
        const legend = document.getElementById('graphLegend');
        const tooltip = document.getElementById('graphTooltip');
        
        svg.innerHTML = '';
        legend.innerHTML = '';

        if(goal.datasets.length === 0) {
             svg.innerHTML = '<text x="50%" y="50%" fill="#555" text-anchor="middle" font-size="12">Create a Variable below to start</text>';
             return;
        }

        // Flatten data to find min/max
        let allPoints = [];
        goal.datasets.forEach(ds => {
            ds.data.forEach(p => allPoints.push(p));
        });

        if(allPoints.length < 2) {
             svg.innerHTML = '<text x="50%" y="50%" fill="#555" text-anchor="middle" font-size="12">Add more data to see graph</text>';
             // Still render legend
             renderLegend(goal);
             return;
        }

        // SVG Dimensions
        const width = svg.clientWidth || 600;
        const height = svg.clientHeight || 300;
        const pad = 40;
        const graphW = width - (pad * 2);
        const graphH = height - (pad * 2);

        // Calculate Ranges
        const dates = allPoints.map(p => new Date(p.date).getTime());
        const values = allPoints.map(p => p.value);
        
        const minTime = Math.min(...dates);
        const maxTime = Math.max(...dates);
        const minVal = 0; 
        const maxVal = Math.max(...values) * 1.1; 

        // Y-Axis Lines (4 lines)
        for(let i=0; i<=4; i++) {
            const yRatio = i / 4;
            const y = (height - pad) - (graphH * yRatio);
            const valLabel = Math.round(minVal + ((maxVal - minVal) * yRatio));
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', pad); line.setAttribute('y1', y);
            line.setAttribute('x2', width - pad); line.setAttribute('y2', y);
            line.setAttribute('class', 'grid-line');
            svg.appendChild(line);

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', 5); text.setAttribute('y', y + 3);
            text.setAttribute('class', 'axis-text');
            text.textContent = valLabel;
            svg.appendChild(text);
        }

        const getX = (dateStr) => {
            const t = new Date(dateStr).getTime();
            const pct = (t - minTime) / (maxTime - minTime);
            return pad + (pct * graphW);
        };
        const getY = (val) => {
            const pct = (val - minVal) / (maxVal - minVal);
            return (height - pad) - (pct * graphH);
        };

        // Draw Lines & Dots
        goal.datasets.forEach((ds) => {
            if(ds.data.length === 0) return;
            
            // Path
            let pathD = `M ${getX(ds.data[0].date)} ${getY(ds.data[0].value)}`;
            ds.data.forEach(p => { pathD += ` L ${getX(p.date)} ${getY(p.value)}`; });

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathD);
            path.setAttribute('stroke', ds.color);
            path.setAttribute('class', 'data-line');
            svg.appendChild(path);
            
            // Dots + Hover Tooltip
            ds.data.forEach(p => {
                const cx = getX(p.date);
                const cy = getY(p.value);
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', cx); circle.setAttribute('cy', cy);
                circle.setAttribute('r', 4);
                circle.setAttribute('fill', ds.color);
                circle.setAttribute('class', 'data-dot');
                
                // Tooltip Events
                circle.addEventListener('mouseenter', (e) => {
                    tooltip.innerHTML = `
                        <div style="font-weight:bold; color:${ds.color}">${ds.label}</div>
                        <div>Date: ${new Date(p.date).toLocaleDateString()}</div>
                        <div>Value: ${p.value}</div>
                    `;
                    tooltip.style.left = (e.offsetX) + 'px';
                    tooltip.style.top = (e.offsetY - 10) + 'px';
                    tooltip.classList.add('visible');
                });
                
                circle.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
                
                svg.appendChild(circle);
            });
        });

        // X-Axis Labels (5 Ticks)
        const totalDuration = maxTime - minTime;
        for(let i=0; i<=4; i++) {
             const t = minTime + (totalDuration * (i/4));
             const x = pad + (graphW * (i/4));
             const dateStr = new Date(t).toLocaleDateString(undefined, {month:'short', day:'numeric'});
             
             const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
             text.setAttribute('x', x); 
             text.setAttribute('y', height - 10);
             text.setAttribute('class', 'axis-text');
             text.setAttribute('text-anchor', 'middle');
             text.textContent = dateStr;
             svg.appendChild(text);
        }

        renderLegend(goal);
    }

    function renderLegend(goal) {
        const legend = document.getElementById('graphLegend');
        legend.innerHTML = '';
        goal.datasets.forEach((ds) => {
             if(ds.label === 'New Variable') return;
             const div = document.createElement('div');
             div.className = 'legend-item';
             div.innerHTML = `<div class="legend-dot" style="background:${ds.color}"></div>${ds.label}`;
             legend.appendChild(div);
        });
    }

    // --- Goal Routine Logic ---
    function openRoutineModal(id) {
        activeGoalId = id;
        renderRoutineList();
        document.getElementById('goalRoutineModal').style.display = 'flex';
        document.getElementById('newRoutineTask').focus();
    }
    function closeRoutineModal() { document.getElementById('goalRoutineModal').style.display = 'none'; activeGoalId = null; }

    function renderRoutineList() {
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        const list = document.getElementById('routineList');
        list.innerHTML = '';
        if(!goal.routine) goal.routine = [];
        
        goal.routine.forEach((task, idx) => {
            list.innerHTML += `
                <div class="routine-item">
                    <span>${task}</span>
                    <div class="routine-icon-group">
                        <span class="routine-action bolt" onclick="addSingleRoutineTask('${task}')">‚ö°</span>
                        <span class="routine-action del" onclick="deleteRoutineTask(${idx})">‚úï</span>
                    </div>
                </div>
            `;
        });
    }

    function addRoutineTask() {
        const input = document.getElementById('newRoutineTask');
        const text = input.value.trim();
        if(text && activeGoalId) {
            const goal = state.longTermGoals.find(g => g.id === activeGoalId);
            if(!goal.routine) goal.routine = [];
            goal.routine.push(text);
            input.value = '';
            saveAndRender(); 
            renderRoutineList();
        }
    }

    function deleteRoutineTask(idx) {
        if(activeGoalId) {
            const goal = state.longTermGoals.find(g => g.id === activeGoalId);
            goal.routine.splice(idx, 1);
            saveAndRender();
            renderRoutineList();
        }
    }

    // --- NEW DAILY Routine Logic (The Left Bolt) ---
    function openDailyRoutineModal() {
        renderDailyRoutineList();
        document.getElementById('dailyRoutineModal').style.display = 'flex';
        document.getElementById('newDailyRoutineTask').focus();
    }
    function closeDailyRoutineModal() { document.getElementById('dailyRoutineModal').style.display = 'none'; }

    function renderDailyRoutineList() {
        const list = document.getElementById('dailyRoutineList');
        list.innerHTML = '';
        state.dailyRoutine.forEach((task, idx) => {
            list.innerHTML += `
                <div class="routine-item">
                    <span>${task}</span>
                    <div class="routine-icon-group">
                        <span class="routine-action bolt" onclick="addSingleRoutineTask('${task}')">‚ö°</span>
                        <span class="routine-action del" onclick="deleteDailyRoutineTask(${idx})">‚úï</span>
                    </div>
                </div>
            `;
        });
    }

    function addDailyRoutineTask() {
        const input = document.getElementById('newDailyRoutineTask');
        const text = input.value.trim();
        if(text) {
            state.dailyRoutine.push(text);
            input.value = '';
            saveAndRender();
            renderDailyRoutineList();
        }
    }

    function deleteDailyRoutineTask(idx) {
        state.dailyRoutine.splice(idx, 1);
        saveAndRender();
        renderDailyRoutineList();
    }

    function addAllDailyRoutinesToToday() {
        if(state.dailyRoutine.length > 0) {
            const key = getTodayKey(viewingDate);
            if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
            
            state.dailyRoutine.forEach(taskText => {
                state.dailyData[key].habits.push({ id: Date.now() + Math.random(), text: taskText, done: false, col: 1, isFrog: false });
            });
            
            saveAndRender();
            showToast(`Added ${state.dailyRoutine.length} tasks to Today!`);
            closeDailyRoutineModal();
        } else {
            showToast("No daily routines set.");
        }
    }

    // --- Common Routine Functions ---
    function addSingleRoutineTask(taskText) {
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.push({ id: Date.now() + Math.random(), text: taskText, done: false, col: 1, isFrog: false });
        saveAndRender();
        showToast(`Added "${taskText}" to Today!`);
    }

    function addAllRoutinesToToday() {
        if(activeGoalId) {
            const goal = state.longTermGoals.find(g => g.id === activeGoalId);
            if(goal && goal.routine && goal.routine.length > 0) {
                const key = getTodayKey(viewingDate);
                if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
                
                goal.routine.forEach(taskText => {
                    state.dailyData[key].habits.push({ id: Date.now() + Math.random(), text: taskText, done: false, col: 1, isFrog: false });
                });
                
                saveAndRender();
                showToast(`Added ${goal.routine.length} tasks to Today!`);
                closeRoutineModal();
            } else {
                showToast("No tasks in routine.");
            }
        }
    }

    // --- SWEEP FEATURE (Broom) ---
    function sweepIncompleteTasks() {
        const currentKey = getTodayKey(viewingDate);
        if (!state.dailyData[currentKey] || !state.dailyData[currentKey].habits) {
            showToast("No incomplete tasks.");
            return;
        }
        
        const habits = state.dailyData[currentKey].habits;
        const incomplete = habits.filter(h => !h.done);
        
        if (incomplete.length === 0) {
            showToast("No incomplete tasks.");
            return;
        }

        // 1. Remove incomplete from current day
        state.dailyData[currentKey].habits = habits.filter(h => h.done);

        // 2. Add to tomorrow
        let tomorrow = new Date(viewingDate); 
        tomorrow.setDate(tomorrow.getDate() + 1);
        const nextKey = getTodayKey(tomorrow);
        
        if (!state.dailyData[nextKey]) state.dailyData[nextKey] = { habits: [], percent: 0 };
        
        incomplete.forEach(h => {
            state.dailyData[nextKey].habits.push({ ...h, col: 1 }); 
        });

        // 3. Save and re-render current day (Instant vanish)
        saveAndRender();
        showToast(`Swept ${incomplete.length} tasks to tomorrow.`);
    }

    function toggleElement(id, baseName) {
        const el = document.getElementById(id);
        const btn = el.previousElementSibling;
        const isOpen = el.classList.toggle('open');
        
        if (baseName === 'Danger Zone' || baseName === 'Sync History') {
             btn.innerText = `${baseName} ${isOpen ? '‚Üë' : '‚Üì'}`;
        } else {
             btn.innerText = `${isOpen ? 'Hide' : 'Show'} ${baseName} ${isOpen ? '‚Üë' : '‚Üì'}`;
        }
    }

    function playStretch() { window.open("https://www.youtube.com/playlist?list=PLWGC5pHwnCsr4tpDxsvUMgXnfHzf26Ezy", '_blank'); }
    function playChillVibe() { window.open('https://www.youtube.com/watch?v=mw4k1tCnAuE&list=PLWGC5pHwnCsrfo7aIeWRw-taMn79IBfdl', 'chillPlayer', 'width=450,height=400'); }

    function playChime() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioCtx.currentTime;
        [174, 348, 522].forEach((freq, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(freq, now);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 3);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 3.1);
        });
    }

    // --- REBUILT TIMER LOGIC ---
    function handleTimerClick(minutes, btnId) {
        if (activeTimer.id !== btnId) startTimer(minutes, btnId);
        else togglePause();
    }

    function startTimer(minutes, btnId) {
        stopTimerEngine();
        activeTimer.id = btnId;
        activeTimer.totalSeconds = minutes * 60;
        activeTimer.isPaused = false;
        const btn = document.getElementById(btnId);
        if(btn) btn.classList.add('active');
        playChime();
        enableFocusMode();
        updateTimerDisplay();
        activeTimer.interval = setInterval(tick, 1000);
    }

    function tick() {
        if(!activeTimer.isPaused) {
            activeTimer.totalSeconds--;
            updateTimerDisplay();
            if (activeTimer.totalSeconds <= 0) timerComplete();
        }
    }

    function togglePause() {
        if (!activeTimer.id) return;
        const btn = document.getElementById(activeTimer.id);
        if(activeTimer.isPaused) {
            activeTimer.isPaused = false;
            if(btn) btn.classList.remove('paused');
            enableFocusMode();
        } else {
            activeTimer.isPaused = true;
            if(btn) btn.classList.add('paused');
            disableFocusMode();
        }
    }

    function timerComplete() {
        stopTimerEngine();
        resetTimerUI(null);
        disableFocusMode();
        startAlarmLoop();
    }

    function startAlarmLoop() {
        document.getElementById('alarmModal').style.display = 'flex';
        playChime();
        alarmLoopInterval = setInterval(playChime, 2000);
    }

    function stopAlarmLoop() {
        clearInterval(alarmLoopInterval);
        alarmLoopInterval = null;
        document.getElementById('alarmModal').style.display = 'none';
    }

    function resetTimer(btnId, defaultVal) {
        if(activeTimer.id === btnId) {
            stopTimerEngine();
            resetTimerUI(defaultVal);
            disableFocusMode();
        }
    }

    function stopTimerEngine() {
        if(activeTimer.interval) clearInterval(activeTimer.interval);
        activeTimer.interval = null;
        activeTimer.isPaused = false;
    }

    function resetTimerUI(val) {
        ['timer25', 'timerCustom', 'timer5'].forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('active', 'paused');
            if(val && id === activeTimer.id) {
                 el.innerText = (typeof val === 'number') ? (val < 10 ? '0'+val+':00' : val+':00') : val;
            }
            else if (id === 'timer25') el.innerText = "25:00";
            else if (id === 'timer5') el.innerText = "05:00";
            else if (id === 'timerCustom') el.innerText = "Custom";
        });
        activeTimer.id = null;
    }

    function updateTimerDisplay() {
        if(!activeTimer.id) return;
        const btn = document.getElementById(activeTimer.id);
        const m = Math.floor(activeTimer.totalSeconds / 60); 
        const s = activeTimer.totalSeconds % 60; 
        btn.innerText = `${m}:${s < 10 ? '0' : ''}${s}`; 
    }

    function enableFocusMode() { document.body.classList.add('focus-mode'); }
    function disableFocusMode() { document.body.classList.remove('focus-mode'); }

    // Custom Timer Modal
    function openCustomTimerModal() {
        if(activeTimer.id === 'timerCustom') { togglePause(); return; }
        document.getElementById('customTimerModal').style.display = 'flex';
        document.getElementById('customTimerInput').focus();
    }
    function closeCustomTimerModal() {
        document.getElementById('customTimerModal').style.display = 'none';
        document.getElementById('customTimerInput').value = '';
    }
    function confirmCustomTimer() {
        const input = document.getElementById('customTimerInput');
        const mins = parseInt(input.value);
        if (mins && mins > 0) {
            const btn = document.getElementById('timerCustom');
            btn.innerText = mins + ":00";
            startTimer(mins, 'timerCustom');
            closeCustomTimerModal();
        }
    }

    // --- Cloud Logic ---
    function setupCloud() {
        const key = prompt("Paste Master Key:"); if (!key) return;
        const bin = prompt("Enter Bin ID (Leave blank if creating new):");
        localStorage.setItem('sync_key', key);
        if (bin) localStorage.setItem('sync_bin_id', bin); else localStorage.removeItem('sync_bin_id');
        CLOUD_CONFIG = { key, binId: bin || '' }; 
        updateSyncStatus("Ready");
        updateDebugId(CLOUD_CONFIG.binId);
        addSyncLog("Cloud successfully linked.");
        startPassiveListener(); 
    }

    function resetCloud() {
        if (confirm("Disconnect Cloud?")) {
            localStorage.removeItem('sync_key'); localStorage.removeItem('sync_bin_id');
            CLOUD_CONFIG = { key: '', binId: '' }; 
            updateSyncStatus("Unlinked");
            updateDebugId("None");
            addSyncLog("Cloud unlinked from this device.");
            stopPassiveListener();
        }
    }

    async function cloudSync(type) {
        if (!CLOUD_CONFIG.key) { setupCloud(); return; }
        updateSyncStatus("Syncing...");
        try {
            if (!CLOUD_CONFIG.binId && type === 'upload') {
                const res = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key, 'X-Bin-Private': 'true' },
                    body: JSON.stringify(state)
                });
                const data = await res.json();
                if (data.metadata) {
                    localStorage.setItem('sync_bin_id', data.metadata.id);
                    CLOUD_CONFIG.binId = data.metadata.id;
                    updateSyncStatus("Linked"); alert("Bin ID Created: " + data.metadata.id);
                    updateDebugId(data.metadata.id);
                    addSyncLog(`Created new cloud bin: ${data.metadata.id}`);
                    startPassiveListener();
                }
            } else {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}${type === 'download' ? '/latest' : ''}?t=${Date.now()}`, {
                    method: type === 'upload' ? 'PUT' : 'GET',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'X-Master-Key': CLOUD_CONFIG.key,
                        'Pragma': 'no-cache', 
                        'Cache-Control': 'no-cache'
                    },
                    body: type === 'upload' ? JSON.stringify({ ...state, _remoteSignal: null }) : null,
                    cache: 'no-store'
                });
                const data = await res.json();
                if (type === 'download') { 
                    state = data.record; 
                    if (!state.longTermGoals) state.longTermGoals = []; 
                    if (!state.dailyRoutine) state.dailyRoutine = [];
                    if (!state.monthNotes) state.monthNotes = {};
                    
                    // Ensure dataset structure exists on older goals
                    state.longTermGoals.forEach(g => { 
                         if(!g.datasets) {
                             if(g.stats) g.datasets = [{label:'Variable 1', color:'#f472b6', data: g.stats}];
                             else g.datasets = [];
                         }
                    });
                    saveAndRender(); 
                    addSyncLog("Manual Download Completed.");
                } else {
                    addSyncLog("Manual Upload Completed.");
                }
                updateSyncStatus("Synced");
            }
        } catch (e) { 
            updateSyncStatus("Error"); 
            addSyncLog(`Sync Error: ${e.message}`);
        }
    }

    // --- WAKE LOCK & VISIBILITY (FIXES THE REFRESH ISSUE) ---
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && CLOUD_CONFIG.binId && !isIntentionallyPaused) {
            addSyncLog("App woken up. Checking cloud...");
            checkRemoteSignal();
            startPassiveListener(); // Restart fresh
        }
    });

    window.addEventListener('focus', () => {
        if (CLOUD_CONFIG.binId && !isIntentionallyPaused) {
            checkRemoteSignal();
            startPassiveListener(); // Restart fresh
        }
    });

    document.addEventListener('touchstart', () => {
        if(!remoteListenInterval && CLOUD_CONFIG.binId && !isIntentionallyPaused) {
            startPassiveListener(); 
        }
    }, {passive: true});


    // --- ALWAYS-ON PASSIVE LISTENER (RECEIVER) ---
    function startPassiveListener() {
        if (remoteListenInterval) clearInterval(remoteListenInterval);
        if(!CLOUD_CONFIG.binId) return;

        document.getElementById('syncPulse').classList.add('pulsing');
        
        // Check every 15 seconds
        remoteListenInterval = setInterval(checkRemoteSignal, 15000);
        // We do NOT call checkRemoteSignal() here to avoid spamming the log if they just touch the screen.
    }

    function stopPassiveListener() {
        if (remoteListenInterval) clearInterval(remoteListenInterval);
        document.getElementById('syncPulse').classList.remove('pulsing');
        remoteListenInterval = null;
    }

    async function checkRemoteSignal() {
        try {
            const statusEl = document.getElementById('syncStatus');
            statusEl.classList.add('blink-blue');
            statusEl.innerText = "Cloud: Checking...";

            // CACHE NUKER FIX: cache: 'no-store' + Pragma headers
            const res = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}/latest?t=${Date.now()}`, {
                method: 'GET',
                headers: { 
                    'X-Master-Key': CLOUD_CONFIG.key, 
                    'X-Bin-Meta': 'false',
                    'Pragma': 'no-cache', 
                    'Cache-Control': 'no-cache'
                },
                cache: 'no-store' 
            });
            const data = await res.json();
            
            statusEl.classList.remove('blink-blue');
            statusEl.innerText = "Cloud: Ready";
            
            const remoteState = data.record || data;

            // IF REQUEST FOUND (Receiver Logic)
            if (remoteState && remoteState._remoteSignal === 'UPLOAD_REQUEST') {
                
                // ECHO PREVENTION: IGNORE MY OWN REQUEST
                if (remoteState._signalSource === DEVICE_ID) return; 

                addSyncLog("Signal Received: Remote device requested upload.");

                playChime();
                statusEl.classList.add('blink-yellow');
                statusEl.innerText = "Cloud: Uploading...";
                document.getElementById('uploadingModal').style.display = 'flex';
                
                // UPLOAD LOCAL DATA + SET SIGNAL TO COMPLETE
                const payload = { ...state, _remoteSignal: 'UPLOAD_COMPLETE' };
                await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key },
                    body: JSON.stringify(payload)
                });
                
                setTimeout(() => {
                    statusEl.classList.remove('blink-yellow');
                    statusEl.innerText = "Cloud: Synced";
                    document.getElementById('uploadingModal').style.display = 'none';
                    showToast("My Data Uploaded. Remote notified.");
                    addSyncLog("Data Auto-Uploaded to Remote.");
                }, 1500);
            }
        } catch(e) { 
            console.log("Listener error:", e); 
            document.getElementById('syncStatus').classList.remove('blink-blue');
        }
    }

    // --- SENDER LOGIC (PHONE) ---
    async function sendRemoteSignal() {
        if(!CLOUD_CONFIG.binId) { alert("Link cloud first!"); return; }
        showToast("Sending Signal to Remote...");
        addSyncLog("Sent Upload Request to Remote.");
        
        // PAUSE OUR OWN LISTENER
        isIntentionallyPaused = true;
        stopPassiveListener();

        try {
            const resGet = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}/latest?t=${Date.now()}`, {
                method: 'GET',
                headers: { 
                    'X-Master-Key': CLOUD_CONFIG.key, 
                    'X-Bin-Meta': 'false',
                    'Pragma': 'no-cache', 
                    'Cache-Control': 'no-cache'
                },
                cache: 'no-store'
            });
            const data = await resGet.json();
            
            let payload = data.record || data;
            payload._remoteSignal = 'UPLOAD_REQUEST'; 
            payload._signalSource = DEVICE_ID;

            await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key },
                body: JSON.stringify(payload)
            });
            
            showToast("Signal Sent. Waiting for remote to reply...");
            
            // START POLLING FOR COMPLETION
            if (pollInterval) clearInterval(pollInterval);
            let attempts = 0;
            pollInterval = setInterval(async () => {
                attempts++;
                
                if(attempts > 20) { 
                    clearInterval(pollInterval); 
                    showToast("Remote timed out."); 
                    addSyncLog("Remote connection timed out (No reply).");
                    isIntentionallyPaused = false;
                    startPassiveListener();
                    return; 
                }
                
                const pollRes = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}/latest?t=${Date.now()}`, {
                    method: 'GET',
                    headers: { 
                        'X-Master-Key': CLOUD_CONFIG.key, 
                        'X-Bin-Meta': 'false',
                        'Pragma': 'no-cache', 
                        'Cache-Control': 'no-cache'
                    },
                    cache: 'no-store'
                });
                const pollData = await pollRes.json();
                
                const pollState = pollData.record || pollData;

                if (pollState && pollState._remoteSignal === 'UPLOAD_COMPLETE') {
                    clearInterval(pollInterval);
                    document.getElementById('newDataModal').style.display = 'flex'; 
                    playChime(); 
                    addSyncLog("Success: Remote uploaded its data.");
                    
                    isIntentionallyPaused = false;
                    startPassiveListener();
                }
            }, 3000); 

        } catch (e) { 
            alert("Signal Error: " + e.message); 
            addSyncLog(`Signal Error: ${e.message}`);
            isIntentionallyPaused = false;
            startPassiveListener();
        }
    }

    function updateSyncStatus(msg) { document.getElementById('syncStatus').innerText = `Cloud: ${msg}`; }
    function updateDebugId(id) { document.getElementById('debugBinId').innerText = `ID: ${id || 'None'}`; }

    function clearAllData() {
        if (prompt("Type 'DELETE' to wipe all history:") === "DELETE") { state = { dailyData: {}, longTermGoals: [], dailyRoutine: [], monthNotes: {} }; saveAndRender(); addSyncLog("Local history wiped.");}
    }

    // --- Task Logic ---
    function addHabit() {
        const input = document.getElementById('habitInput'); if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.push({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: false });
        input.value = ''; saveAndRender();
    }

    function addFrog() {
        const input = document.getElementById('frogInput'); if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.unshift({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: true });
        input.value = ''; saveAndRender();
    }

    function requestDelete(btn, id) {
        const arrow = btn.previousElementSibling; 
        if (btn.classList.contains('confirm')) { 
            clearTimeout(deleteTimeouts[id]); deleteHabit(id); 
        } else {
            btn.classList.add('confirm'); btn.innerText = '‚úì'; 
            if(arrow) arrow.style.display = 'block';
            deleteTimeouts[id] = setTimeout(() => { 
                btn.classList.remove('confirm'); btn.innerText = '‚úï'; 
                if(arrow) arrow.style.display = 'none';
            }, 3000);
        }
    }

    function deleteHabit(id) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.filter(h => h.id !== id); saveAndRender(); }
    function toggleHabit(id) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === id ? {...h, done: !h.done} : h); saveAndRender(); }
    function moveHabit(id, col) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === id ? {...h, col: col} : h); saveAndRender(); }
    
    function forwardHabit(id) {
        const currentKey = getTodayKey(viewingDate);
        const hToMove = state.dailyData[currentKey].habits.find(h => h.id === id);
        state.dailyData[currentKey].habits = state.dailyData[currentKey].habits.filter(h => h.id !== id);
        let tomorrow = new Date(viewingDate); tomorrow.setDate(tomorrow.getDate() + 1);
        const nextKey = getTodayKey(tomorrow);
        if (!state.dailyData[nextKey]) state.dailyData[nextKey] = { habits: [], percent: 0 };
        state.dailyData[nextKey].habits.push({ ...hToMove, done: false });
        saveAndRender();
    }

    // --- Drag and Drop (Tasks) ---
    let draggedItem = null;

    function handleDragStart(e) { draggedItem = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', this.dataset.id); setTimeout(() => this.classList.add('dragging'), 0); }
    function handleDragEnd(e) { this.classList.remove('dragging'); draggedItem = null; }

    function handleDragOver(e) {
        e.preventDefault();
        const container = e.currentTarget;
        if (!container.classList.contains('column')) return; 
        const afterElement = getDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.habit-item.dragging');
        if (draggable) {
            if (afterElement == null) container.appendChild(draggable);
            else container.insertBefore(draggable, afterElement);
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        const newColIndex = parseInt(e.currentTarget.dataset.col);
        const draggable = document.querySelector('.habit-item.dragging');
        if(!draggable) return;
        const id = parseInt(draggable.dataset.id);
        const key = getTodayKey(viewingDate);
        let habits = state.dailyData[key].habits;
        const habitIndex = habits.findIndex(h => h.id === id);
        if(habitIndex === -1) return;
        
        habits[habitIndex].col = newColIndex;

        const newHabitsOrder = [];
        [0, 1, 2].forEach(colIdx => {
            const colEl = document.getElementById(`col-${colIdx}`);
            const itemEls = colEl.querySelectorAll('.habit-item');
            itemEls.forEach(el => {
                const itemId = parseInt(el.dataset.id);
                const item = habits.find(h => h.id === itemId);
                if (item) { item.col = colIdx; newHabitsOrder.push(item); }
            });
        });
        state.dailyData[key].habits = newHabitsOrder;
        saveAndRender(); // UPDATED: Trigger full render to update squares!
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.habit-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // --- LONG TERM GOALS LOGIC ---
    function confirmAddGoal() {
        const text = document.getElementById('newGoalText').value;
        if (state.longTermGoals.length >= 9) { showToast("Max 9 Goals reached."); return; }
        if (text) {
            state.longTermGoals.push({ id: Date.now(), text: text, done: false, milestones: [], notes: '', routine: [], datasets: [] });
            saveAndRender();
            closeGoalModal();
        }
    }

    function toggleGoal(id) {
        state.longTermGoals = state.longTermGoals.map(g => g.id === id ? { ...g, done: !g.done } : g);
        saveAndRender();
    }

    function requestDeleteGoal(btn, id) {
        if (btn.classList.contains('confirm')) { 
            clearTimeout(deleteTimeouts['g'+id]); deleteGoal(id); 
        } else {
            btn.classList.add('confirm'); btn.innerText = '‚úì'; 
            deleteTimeouts['g'+id] = setTimeout(() => { 
                btn.classList.remove('confirm'); btn.innerText = '‚úï'; 
            }, 3000);
        }
    }

    function deleteGoal(id) {
        state.longTermGoals = state.longTermGoals.filter(g => g.id !== id);
        saveAndRender();
    }

    function addMilestone(goalId) {
        openMilestoneModal(goalId);
    }

    function toggleMilestone(goalId, msId) {
        const goal = state.longTermGoals.find(g => g.id === goalId);
        if (goal) {
            goal.milestones = goal.milestones.map(m => m.id === msId ? { ...m, done: !m.done } : m);
            saveAndRender();
        }
    }

    function requestDeleteMilestone(btn, gId, mId, e) {
        if(e) e.stopPropagation();
        if (btn.classList.contains('confirm')) { 
            clearTimeout(deleteTimeouts['m'+mId]); deleteMilestone(gId, mId); 
        } else {
            btn.classList.add('confirm'); btn.innerText = '‚úì'; 
            deleteTimeouts['m'+mId] = setTimeout(() => { 
                btn.classList.remove('confirm'); btn.innerText = '‚úï'; 
            }, 3000);
        }
    }

    function deleteMilestone(goalId, msId) {
        const goal = state.longTermGoals.find(g => g.id === goalId);
        if (goal) {
            goal.milestones = goal.milestones.filter(m => m.id !== msId);
            saveAndRender();
        }
    }

    // Milestone Drag & Drop (Vertical)
    let draggedMs = null;
    let sourceGoalId = null;

    function handleMsDragStart(e) {
        draggedMs = this;
        sourceGoalId = parseInt(this.closest('.goal-card').dataset.id);
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => this.classList.add('dragging'), 0);
    }

    function handleMsDragEnd(e) {
        this.classList.remove('dragging');
        draggedMs = null;
        sourceGoalId = null;
    }

    function handleMsDragOver(e) {
        e.preventDefault();
        const container = e.currentTarget;
        if (parseInt(container.dataset.goalId) !== sourceGoalId) return;

        const afterElement = getMsDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.milestone-box.dragging');
        if (draggable) {
            if (afterElement == null) container.appendChild(draggable);
            else container.insertBefore(draggable, afterElement);
        }
    }

    function handleMsDrop(e) {
        e.preventDefault();
        const container = e.currentTarget;
        if (parseInt(container.dataset.goalId) !== sourceGoalId) return;

        const goalId = sourceGoalId;
        const goal = state.longTermGoals.find(g => g.id === goalId);
        
        const newMsOrder = [];
        container.querySelectorAll('.milestone-box').forEach(el => {
            const msId = parseInt(el.dataset.id);
            const item = goal.milestones.find(m => m.id === msId);
            if (item) newMsOrder.push(item);
        });

        goal.milestones = newMsOrder;
        saveAndRender();
    }

    function getMsDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.milestone-box:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function renderGoals() {
        const grid = document.getElementById('goalsGrid');
        grid.innerHTML = '';
        
        if (!state.longTermGoals) state.longTermGoals = [];

        state.longTermGoals.forEach(g => {
            const card = document.createElement('div');
            card.className = `goal-card ${g.done ? 'done' : ''}`;
            card.dataset.id = g.id;
            
            let html = `
                <div class="habit-row">
                    <div class="add-ms-header-btn" onclick="addMilestone(${g.id}); event.stopPropagation();"></div>
                    <div style="flex:1; margin-left:10px; cursor:pointer;" onclick="toggleGoal(${g.id})">
                        <span style="font-weight:bold; font-size:0.9rem; color:#fff;">${g.text}</span>
                    </div>
                    <div class="action-btns">
                        <div class="pen-btn" onclick="openStatsModal(${g.id})">üìà</div>
                        <div class="pen-btn" onclick="openNotesModal(${g.id})">‚úé</div>
                        <div class="routine-btn" onclick="openRoutineModal(${g.id})">‚ö°</div>
                        <div class="delete-btn" onclick="requestDeleteGoal(this, ${g.id})">‚úï</div>
                    </div>
                </div>
            `;
            
            html += `<div class="milestone-list" data-goal-id="${g.id}">`;
            g.milestones.forEach(m => {
                html += `
                    <div class="milestone-box ${m.done ? 'done' : ''}" 
                         draggable="true" data-id="${m.id}"
                         onclick="toggleMilestone(${g.id}, ${m.id})">
                         ${m.text}
                         <div class="ms-del" onclick="requestDeleteMilestone(this, ${g.id}, ${m.id}, event)">‚úï</div>
                    </div>
                `;
            });
            html += `</div>`;

            card.innerHTML = html;
            grid.appendChild(card);
            
            const msList = card.querySelector('.milestone-list');
            msList.addEventListener('dragover', handleMsDragOver);
            msList.addEventListener('drop', handleMsDrop);
            
            card.querySelectorAll('.milestone-box').forEach(box => {
                box.addEventListener('dragstart', handleMsDragStart);
                box.addEventListener('dragend', handleMsDragEnd);
            });
        });
    }

    // --- Core Render Logic ---
    function saveAndRender(shouldRenderBoard = true) {
        const key = getTodayKey(viewingDate);
        const dayData = state.dailyData[key] || { habits: [], percent: 0 };
        const total = dayData.habits.length; const doneCount = dayData.habits.filter(h => h.done).length;
        dayData.percent = total > 0 ? Math.round((doneCount / total) * 100) : 0;
        
        document.getElementById('frogInput').style.display = dayData.habits.some(h => h.isFrog) ? 'none' : 'block';
        
        document.getElementById('dateDisplay').innerText = viewingDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        
        const mainEl = document.getElementById('mainPercent');
        const wasComplete = mainEl.classList.contains('complete');
        mainEl.innerText = dayData.percent + '%';
        if (dayData.percent === 100 && total > 0) {
            if (!wasComplete) triggerFireworks();
            mainEl.classList.add('complete');
            updateQuote(true);
        } else {
            mainEl.classList.remove('complete');
            updateQuote(false);
        }

        let totalFrogs = 0;
        Object.values(state.dailyData).forEach(d => {
            if(d.habits) {
                d.habits.forEach(h => { if(h.isFrog && h.done) totalFrogs++; });
            }
        });
        const frogCounter = document.getElementById('frogCounter');
        if(frogCounter) frogCounter.innerText = `${totalFrogs} Frogs Eaten`;

        state.dailyData[key] = dayData; localStorage.setItem('discipline_v12', JSON.stringify(state));
        if (shouldRenderBoard) renderBoard(dayData.habits); 
        renderYear();
        renderGoals(); 
    }

    function updateQuote(isComplete) {
        const textEl = document.getElementById('quoteText');
        
        if (isComplete) {
            const hasWonBefore = localStorage.getItem('victory_first_done');
            if (!hasWonBefore) {
                textEl.innerText = `"${firstVictoryQuote}"`;
                localStorage.setItem('victory_first_done', 'true');
            } else {
                textEl.innerText = `"${randomVictoryQuotes[Math.floor(Math.random() * randomVictoryQuotes.length)]}"`;
            }
            textEl.dataset.author = "You";
        } else {
            const hasVisited = localStorage.getItem('frog_first_visit_done');
            let selectedQuote;
            
            if (!hasVisited) {
                selectedQuote = markTwainQuote;
                localStorage.setItem('frog_first_visit_done', 'true');
            } else {
                const idx = viewingDate.getDate() % quotesList.length;
                selectedQuote = quotesList[idx];
            }
            
            textEl.innerText = `"${selectedQuote.text}"`;
            textEl.dataset.author = selectedQuote.author;
        }
    }

    function renderBoard(habits) {
        const cols = [document.getElementById('col-0'), document.getElementById('col-1'), document.getElementById('col-2')];
        cols.forEach(c => {
            c.innerHTML = '';
            c.addEventListener('dragover', handleDragOver);
            c.addEventListener('drop', handleDrop);
        });
        
        habits.forEach(h => {
            const item = document.createElement('div');
            item.className = `habit-item ${h.done ? 'done' : ''} ${h.isFrog ? 'is-frog' : ''}`;
            item.draggable = true;
            item.dataset.id = h.id;
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);

            item.innerHTML = `
                <div class="habit-row">
                    <div style="display:flex; align-items:center; flex:1;" onclick="toggleHabit(${h.id})">
                        <div class="check"></div><span style="margin-left:10px;">${h.isFrog ? 'üê∏ ' : ''}${h.text}</span>
                    </div>
                    <div class="action-btns">
                        <div class="move-btn" onclick="forwardHabit(${h.id}); event.stopPropagation();">‚Üí</div>
                        <div class="delete-btn" onclick="requestDelete(this, ${h.id}); event.stopPropagation();">‚úï</div>
                    </div>
                </div>
                <div class="col-selector-wrap">
                    <div class="sq-btn ${h.col === 0 ? 'active' : ''}" onclick="moveHabit(${h.id}, 0)"></div>
                    <div class="sq-btn ${h.col === 1 ? 'active' : ''}" onclick="moveHabit(${h.id}, 1)"></div>
                    <div class="sq-btn ${h.col === 2 ? 'active' : ''}" onclick="moveHabit(${h.id}, 2)"></div>
                </div>`;
            cols[h.col ?? 1].appendChild(item);
        });
    }

    function renderYear() {
        const grid = document.getElementById('yearGrid'); grid.innerHTML = '';
        const year = new Date().getFullYear();
        ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].forEach((name, mIdx) => {
            const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
            let monthTotal = 0, daysLogged = 0;
            const monthKey = `${year}-${mIdx}`;
            
            // Month Header with Edit Icon
            let monthHtml = `<div class="month-card">
                <div class="month-title">
                    <div class="month-name-btn" onclick="openRichTextModal('month', '${monthKey}')">
                       ${name} <span>‚úé</span>
                    </div>
                    <span id="m-pct-${mIdx}">0%</span>
                </div>
                <div class="month-days">`;
                
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(mIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayData = state.dailyData[dateKey];
                
                let score = 0;
                let hasFrogAndDone = false;
                if (dayData && dayData.habits && dayData.habits.length > 0) {
                    const totalTasks = dayData.habits.length;
                    const doneTasks = dayData.habits.filter(h => h.done).length;
                    score = Math.round((doneTasks / totalTasks) * 100);
                    hasFrogAndDone = dayData.habits.some(h => h.isFrog && h.done);
                    monthTotal += score; 
                    daysLogged++;
                }

                let bgStyle = 'background: rgba(255, 255, 255, 0.05)';
                if (score === 100) {
                    bgStyle = 'background: var(--success); box-shadow: 0 0 5px rgba(34, 197, 94, 0.4);';
                } else if (score > 0) {
                    bgStyle = `background: rgba(59, 130, 246, ${0.2 + (score/100)*0.8})`;
                }

                monthHtml += `<div class="day-sq ${dateKey === getTodayKey(viewingDate) ? 'active' : ''}" 
                                   onclick="jumpToDate('${dateKey}')" 
                                   style="${bgStyle}"
                                   data-pct="${score}% Completed">
                                   ${hasFrogAndDone ? 'üê∏' : ''}</div>`;
            }
            grid.innerHTML += monthHtml + `</div></div>`;
            
            const finalAvg = daysLogged > 0 ? Math.round(monthTotal / daysLogged) : 0;
            const label = document.getElementById(`m-pct-${mIdx}`);
            if (label) label.innerText = finalAvg + '%';
        });
    }

    function triggerFireworks() {
        const container = document.getElementById('firework-container');
        for (let b = 0; b < 4; b++) {
            setTimeout(() => {
                const centerX = (20 + Math.random() * 60) + '%';
                const centerY = (15 + Math.random() * 25) + '%';
                for (let i = 0; i < 55; i++) {
                    const p = document.createElement('div'); p.className = 'particle';
                    p.style.left = centerX; p.style.top = centerY;
                    const angle = Math.random() * Math.PI * 2; const dist = 100 + Math.random() * 250;
                    p.style.setProperty('--x', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--y', Math.sin(angle) * dist + 'px');
                    p.style.background = `hsl(${Math.random() * 360}, 80%, 60%)`;
                    container.appendChild(p); setTimeout(() => p.remove(), 1200);
                }
            }, b * 250);
        }
    }

    // --- TIMEZONE FIX ---
    function getTodayKey(date) { 
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    function changeDate(d) { viewingDate.setDate(viewingDate.getDate() + d); saveAndRender(); }
    function jumpToToday() { viewingDate = new Date(); saveAndRender(); }
    function jumpToDate(s) { viewingDate = new Date(s + 'T00:00:00'); saveAndRender(); }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || (e.target.tagName === 'DIV' && e.target.isContentEditable)) return; 
        
        if (e.key.toLowerCase() === 'f') {
            e.preventDefault();
            const frogInput = document.getElementById('frogInput');
            if (frogInput && frogInput.style.display !== 'none') frogInput.focus();
        } 
        else if (e.key.toLowerCase() === 'n') {
            e.preventDefault();
            document.getElementById('habitInput').focus();
        }
        else if (e.key === 'Escape') {
            closeSyncModal(); closeGoalModal(); closeRichTextModal(); closeMilestoneModal(); closeRoutineModal(); closeDailyRoutineModal(); closeCustomTimerModal(); closeStatsModal();
        }
    });

    document.getElementById('habitInput').addEventListener('keypress', e => e.key === 'Enter' && addHabit());
    document.getElementById('frogInput').addEventListener('keypress', e => e.key === 'Enter' && addFrog());
    document.getElementById('newGoalText').addEventListener('keypress', e => e.key === 'Enter' && confirmAddGoal());

    // START ON LOAD
    if (CLOUD_CONFIG.key) {
        updateSyncStatus("Ready");
        updateDebugId(CLOUD_CONFIG.binId);
        if(CLOUD_CONFIG.binId) startPassiveListener(); 
    }
    saveAndRender();
</script>
</body>
</html>
