<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline Dashboard</title>
    <style>
        :root { --bg: #09090b; --card: #18181b; --text: #fafafa; --primary: #3b82f6; --border: #27272a; --success: #22c55e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .container { width: 100%; max-width: 1000px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Fireworks */
        .firework-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 99; }
        .particle { position: absolute; width: 5px; height: 5px; border-radius: 50%; animation: explode 1.2s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--x), var(--y)); opacity: 0; } }

        /* Top Section */
        .today-section { text-align: center; margin-top: 40px; }
        .quote-text { font-size: 1.1rem; color: #a1a1aa; font-style: italic; display: block; margin-bottom: 20px; min-height: 3em; max-width: 600px; }
        .main-percent { font-size: 6rem; font-weight: 800; color: var(--primary); line-height: 1; transition: 0.5s; }
        .main-percent.complete { color: var(--success); text-shadow: 0 0 30px rgba(34, 197, 94, 0.6); transform: scale(1.1); }
        .label { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; color: #71717a; font-weight: 600; margin-top: 10px; }

        /* Inputs */
        .input-group { width: 100%; max-width: 500px; margin: 30px auto; display: flex; flex-direction: column; gap: 10px; }
        input { width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 18px; border-radius: 14px; box-sizing: border-box; outline: none; font-size: 1rem; text-align: center; transition: 0.3s; }
        #frogInput { border-color: #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.1); }
        #frogInput::placeholder { color: #854d0e; }

        /* Board Columns */
        .board { display: flex; justify-content: center; gap: 15px; width: 100%; margin-bottom: 50px; align-items: flex-start; flex-wrap: wrap; }
        .column { flex: 1; min-width: 300px; max-width: 320px; border-radius: 16px; padding: 5px; }
        
        /* Task Cards */
        .habit-item { background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 12px; transition: 0.2s; position: relative; }
        .habit-item.is-frog { border: 1px solid #facc15; background: linear-gradient(145deg, #18181b, #1e1b12); }
        .habit-item.done { opacity: 0.4; border-left: 4px solid var(--primary); }
        .habit-item.is-frog.done { border-left: 4px solid #facc15; opacity: 0.6; }
        
        .habit-row { display: flex; justify-content: space-between; align-items: center; }
        .check { width: 24px; height: 24px; border: 2px solid #3f3f46; border-radius: 7px; flex-shrink: 0; cursor: pointer; }
        .done .check { background: var(--primary); border-color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .is-frog.done .check { background: #facc15; border-color: #facc15; }
        .done .check::after { content: '‚úì'; color: white; font-weight: bold; font-size: 14px; }
        
        /* Action Buttons */
        .action-btns { display: flex; gap: 12px; align-items: center; }
        .move-btn { color: var(--primary); cursor: pointer; font-size: 1.1rem; font-weight: bold; display: none; }
        .delete-btn { color: var(--success); opacity: 0.8; cursor: pointer; font-size: 1.1rem; transition: 0.2s; min-width: 18px; text-align: center; }
        .delete-btn:hover { opacity: 1; }
        .delete-btn.confirm { color: var(--success); font-weight: bold; opacity: 1; }

        /* Selectors */
        .col-selector-wrap { display: flex; justify-content: center; gap: 10px; border-top: 1px solid #27272a; padding-top: 10px; }
        .sq-btn { width: 14px; height: 14px; border: 1px solid #3f3f46; border-radius: 3px; cursor: pointer; transition: 0.2s; }
        .sq-btn.active { background: var(--success); border-color: var(--success); }

        /* Yearly Grid */
        .year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; border-top: 1px solid var(--border); padding-top: 60px; width: 100%; }
        .month-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
        .month-title { display: flex; justify-content: space-between; font-size: 0.6rem; color: #a1a1aa; margin-bottom: 8px; text-transform: uppercase; }
        .month-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-sq { width: 100%; aspect-ratio: 1; background: #27272a; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; position: relative; }
        .day-sq.active { outline: 2px solid var(--primary); }

        /* Nav Bar */
        .nav-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; margin: 40px auto; padding-top: 20px; border-top: 1px solid var(--border); }
        .nav-btn { background: none; border: 1px solid var(--border); color: var(--text); padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; }
        .current-date-display { font-weight: 800; color: var(--primary); cursor: pointer; }

        /* Footer Section */
        .footer-tools { margin-top: auto; padding: 40px 0; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        #timerDisplay { font-family: monospace; font-size: 1.4rem; color: var(--success); font-weight: bold; cursor: pointer; padding: 12px 40px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; user-select: none; }
        #timerDisplay.active { animation: breathe 3s infinite; border-color: var(--success); }
        @keyframes breathe { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .button-row { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .tool-btn { 
            text-decoration: none; color: #a1a1aa; font-size: 0.7rem; text-transform: uppercase; 
            letter-spacing: 2px; padding: 10px 20px; border: 1px solid #27272a; border-radius: 30px; 
            transition: 0.3s; font-weight: bold; background: none; cursor: pointer;
        }
        .tool-btn:hover { background: #fff; color: #000; border-color: #fff; }

        @media (max-width: 800px) { .year-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<div id="firework-container" class="firework-container"></div>

<div class="container">
    <div class="today-section">
        <span class="quote-text" id="quoteText">"If you were to swallow a frog, do it first thing in the morning."</span>
        <div class="label" id="frogLabel">Today's Frog</div>
        <div class="main-percent" id="mainPercent">0%</div>
    </div>

    <div class="input-group">
        <input type="text" id="frogInput" placeholder="Set today's BIG FROG (one per day)...">
        <input type="text" id="habitInput" placeholder="Add another task...">
    </div>

    <div class="board">
        <div class="column" id="col-0"></div>
        <div class="column" id="col-1"></div>
        <div class="column" id="col-2"></div>
    </div>

    <div class="year-grid" id="yearGrid"></div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="changeDate(-1)">‚Üê Yesterday</button>
        <div class="current-date-display" id="dateDisplay" onclick="jumpToToday()">Date</div>
        <button class="nav-btn" onclick="changeDate(1)">Next Day ‚Üí</button>
    </div>

    <div class="footer-tools">
        <div id="timerDisplay" onclick="toggleTimer()" ondblclick="resetTimer()">25:00</div>
        
        <div id="syncStatus" style="font-size: 0.6rem; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Cloud: Unlinked</div>
        
        <div class="button-row">
            <button onclick="cloudSync()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">One-Tap Sync</button>
            <button onclick="setupCloud()" class="tool-btn">Link Device</button>
            <button onclick="resetCloud()" class="tool-btn" style="color: #71717a; font-size: 0.6rem;">Reset Cloud Link</button>
        </div>

        <div class="button-row">
            <button onclick="playChillVibe()" class="tool-btn">Chill Music</button>
            <a href="https://www.youtube.com/watch?v=mw4k1tCnAuE" target="_blank" class="tool-btn">Handpan Focus</a>
            <a href="https://www.brain.fm" target="_blank" class="tool-btn">meditate now</a>
        </div>

        <button onclick="clearAllData()" class="tool-btn" style="color: #ef4444; border-color: #ef4444; margin-top: 20px; font-size: 0.5rem; opacity: 0.4;">Clear All Habit History</button>
    </div>
</div>

<script>
    const frogQuotes = [
        "If you were to swallow a frog, do it first thing in the morning.",
        "If you have to eat two frogs, eat the big one first.",
        "Discipline is the bridge between goals and accomplishment.",
        "The pain of discipline is far less than the pain of regret.",
        "He who has a why to live can bear almost any how.",
        "Focus on being productive instead of busy.",
        "Excellence is not an act, but a habit.",
        "Don't wish it were easier, wish you were better.",
        "Your future self is watching you right now through memories.",
        "Discipline equals freedom."
    ];
    const victoryQuotes = ["Well done. You conquered the day.", "Consistency is power.", "Excellence is a habit.", "Discipline equals freedom.", "Rest easy. You earned it.", "The version of you tomorrow will thank you."];
    
    let state = JSON.parse(localStorage.getItem('discipline_v12')) || { dailyData: {} };
    let viewingDate = new Date();
    let timerInterval, timeLeft = 1500, audioCtx;
    let deleteTimeouts = {};

    // --- ENHANCED CLOUD SYNC LOGIC ---
    let CLOUD_CONFIG = {
        key: localStorage.getItem('sync_key') || '',
        binId: localStorage.getItem('sync_bin_id') || ''
    };

    function updateSyncStatus(msg) {
        document.getElementById('syncStatus').innerText = `Cloud: ${msg}`;
    }

    async function setupCloud() {
        const key = prompt("Enter your JSONBin Master Key:");
        if (!key) return;
        const bin = prompt("Enter your Bin ID (leave blank to create a new one):");
        
        localStorage.setItem('sync_key', key);
        if (bin) {
            localStorage.setItem('sync_bin_id', bin);
        } else {
            localStorage.removeItem('sync_bin_id');
        }
        
        // Refresh local config and UI
        CLOUD_CONFIG.key = key;
        CLOUD_CONFIG.binId = bin || '';
        updateSyncStatus("Ready");
        alert("Keys saved! Click 'One-Tap Sync' to finish.");
    }

    function resetCloud() {
        if (confirm("Disconnect from Cloud? This removes your keys so you can re-link. Your habits will NOT be deleted.")) {
            localStorage.removeItem('sync_key');
            localStorage.removeItem('sync_bin_id');
            CLOUD_CONFIG.key = '';
            CLOUD_CONFIG.binId = '';
            updateSyncStatus("Unlinked");
            // Immediately trigger setup again
            setupCloud();
        }
    }

    async function cloudSync() {
        if (!CLOUD_CONFIG.key) {
            setupCloud();
            return;
        }
        updateSyncStatus("Syncing...");
        try {
            if (!CLOUD_CONFIG.binId) {
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key, 'X-Bin-Private': 'true' },
                    body: JSON.stringify(state)
                });
                const result = await response.json();
                if (result.metadata) {
                    localStorage.setItem('sync_bin_id', result.metadata.id);
                    CLOUD_CONFIG.binId = result.metadata.id;
                    updateSyncStatus("Linked & Saved");
                    alert("New Cloud Locker Created! Bin ID: " + result.metadata.id);
                } else { throw new Error("Key Error"); }
            } else {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}/latest`, {
                    headers: { 'X-Master-Key': CLOUD_CONFIG.key }
                });
                const remoteData = await response.json();
                if (confirm("Download from Cloud? (OK) or Upload to Cloud? (Cancel)")) {
                    state = remoteData.record;
                    saveAndRender();
                    updateSyncStatus("Downloaded");
                } else {
                    await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key },
                        body: JSON.stringify(state)
                    });
                    updateSyncStatus("Uploaded");
                }
            }
        } catch (error) {
            updateSyncStatus("Error");
            alert("Sync failed. Check your Secret Key and try again.");
        }
    }

    function clearAllData() {
        if (confirm("üö® WIPE ALL HISTORY? This cannot be undone.")) {
            state = { dailyData: {} };
            localStorage.setItem('discipline_v12', JSON.stringify(state));
            saveAndRender();
        }
    }

    if (CLOUD_CONFIG.key) updateSyncStatus("Ready");

    function updateQuote(isComplete) {
        const textEl = document.getElementById('quoteText');
        if (isComplete) {
            textEl.innerText = `"${victoryQuotes[Math.floor(Math.random() * victoryQuotes.length)]}"`;
        } else {
            const dayIdx = viewingDate.getDate() % frogQuotes.length;
            textEl.innerText = `"${frogQuotes[dayIdx]}"`;
        }
    }

    function playChillVibe() {
        const url = `https://www.youtube.com/watch?v=nPb2xhiyBXE&list=PLWGC5pHwnCsrfo7aIeWRw-taMn79IBfdl&index=${Math.floor(Math.random()*20)+1}&shuffle=1&autoplay=1`;
        window.open(url, 'chillPlayer', 'width=450,height=400,scrollbars=no,resizable=yes,status=no,menu=no');
    }

    function playChime() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioCtx.currentTime;
        const frequencies = [174, 174.5, 348, 522]; 
        frequencies.forEach((freq, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = i === 0 ? 'sine' : 'triangle';
            osc.frequency.setValueAtTime(freq, now);
            osc.frequency.exponentialRampToValueAtTime(freq - 0.5, now + 4);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(i === 0 ? 0.3 : 0.1, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 4);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 4.1);
        });
    }

    function toggleTimer() {
        if (!audioCtx) audioCtx = new AudioContext();
        const el = document.getElementById('timerDisplay');
        if (timerInterval) { 
            clearInterval(timerInterval); timerInterval = null; el.classList.remove('active'); 
        } else {
            if (timeLeft === 1500) playChime();
            el.classList.add('active');
            timerInterval = setInterval(() => {
                timeLeft--; updateTimerUI();
                if (timeLeft <= 0) { 
                    clearInterval(timerInterval); timerInterval = null; playChime();
                    el.innerText = "FINISH"; el.classList.remove('active'); 
                }
            }, 1000);
        }
    }

    function resetTimer() { clearInterval(timerInterval); timerInterval = null; timeLeft = 1500; updateTimerUI(); document.getElementById('timerDisplay').classList.remove('active'); }
    function updateTimerUI() { const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; }

    function requestDelete(btn, id) {
        const arrow = btn.previousElementSibling;
        if (btn.classList.contains('confirm')) {
            clearTimeout(deleteTimeouts[id]);
            deleteHabit(id);
        } else {
            btn.classList.add('confirm');
            btn.innerText = '‚úì';
            arrow.style.display = 'block';
            deleteTimeouts[id] = setTimeout(() => {
                btn.classList.remove('confirm');
                btn.innerText = '‚úï';
                arrow.style.display = 'none';
            }, 5000);
        }
    }

    function forwardHabit(id) {
        const currentKey = getTodayKey(viewingDate);
        const habitToMove = state.dailyData[currentKey].habits.find(h => h.id === id);
        state.dailyData[currentKey].habits = state.dailyData[currentKey].habits.filter(h => h.id !== id);
        let tomorrow = new Date(viewingDate);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const nextKey = getTodayKey(tomorrow);
        if (!state.dailyData[nextKey]) state.dailyData[nextKey] = { habits: [], percent: 0 };
        state.dailyData[nextKey].habits.push({ ...habitToMove, done: false });
        saveAndRender();
    }

    function addHabit() {
        const input = document.getElementById('habitInput');
        if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.push({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: false });
        input.value = ''; saveAndRender();
    }

    function addFrog() {
        const input = document.getElementById('frogInput');
        if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits = state.dailyData[key].habits.filter(h => !h.isFrog);
        state.dailyData[key].habits.unshift({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: true });
        input.value = ''; saveAndRender();
    }

    function moveHabit(habitId, newCol) {
        const key = getTodayKey(viewingDate);
        state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === habitId ? { ...h, col: newCol } : h);
        saveAndRender();
    }

    function toggleHabit(id) {
        const key = getTodayKey(viewingDate);
        state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === id ? {...h, done: !h.done} : h);
        saveAndRender();
    }

    function deleteHabit(id) {
        const key = getTodayKey(viewingDate);
        state.dailyData[key].habits = state.dailyData[key].habits.filter(h => h.id !== id);
        saveAndRender();
    }

    function triggerFireworks() {
        const container = document.getElementById('firework-container');
        for (let b = 0; b < 4; b++) {
            setTimeout(() => {
                const centerX = (20 + Math.random() * 60) + '%';
                const centerY = (15 + Math.random() * 25) + '%';
                for (let i = 0; i < 55; i++) {
                    const p = document.createElement('div'); p.className = 'particle';
                    p.style.left = centerX; p.style.top = centerY;
                    const angle = Math.random() * Math.PI * 2; const dist = 100 + Math.random() * 250;
                    p.style.setProperty('--x', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--y', Math.sin(angle) * dist + 'px');
                    p.style.background = `hsl(${Math.random() * 360}, 80%, 60%)`;
                    container.appendChild(p); setTimeout(() => p.remove(), 1200);
                }
            }, b * 250);
        }
    }

    function getTodayKey(date) { return date.toISOString().split('T')[0]; }
    document.getElementById('habitInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addHabit(); });
    document.getElementById('frogInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addFrog(); });

    function saveAndRender() {
        const key = getTodayKey(viewingDate);
        const dayData = state.dailyData[key] || { habits: [], percent: 0 };
        const hasFrog = dayData.habits.some(h => h.isFrog);
        document.getElementById('frogInput').style.display = hasFrog ? 'none' : 'block';
        const total = dayData.habits.length;
        const doneCount = dayData.habits.filter(h => h.done).length;
        const percent = total > 0 ? Math.round((doneCount / total) * 100) : 0;
        dayData.percent = percent;
        state.dailyData[key] = dayData;
        document.getElementById('dateDisplay').innerText = viewingDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        const mainEl = document.getElementById('mainPercent');
        const wasComplete = mainEl.classList.contains('complete');
        mainEl.innerText = percent + '%';
        if (percent === 100 && total > 0) {
            if (!wasComplete) triggerFireworks();
            mainEl.classList.add('complete');
            updateQuote(true);
        } else {
            mainEl.classList.remove('complete');
            updateQuote(false);
        }
        localStorage.setItem('discipline_v12', JSON.stringify(state));
        renderBoard(dayData.habits); renderYear();
    }

    function renderBoard(habits) {
        const cols = [document.getElementById('col-0'), document.getElementById('col-1'), document.getElementById('col-2')];
        cols.forEach(c => c.innerHTML = '');
        habits.forEach(h => {
            const item = document.createElement('div');
            item.className = `habit-item ${h.done ? 'done' : ''} ${h.isFrog ? 'is-frog' : ''}`;
            item.innerHTML = `
                <div class="habit-row">
                    <div style="display:flex; align-items:center; overflow:hidden; flex:1;" onclick="toggleHabit(${h.id})">
                        <div class="check"></div>
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-left:10px;">
                            ${h.isFrog ? 'üê∏ ' : ''}${h.text}
                        </span>
                    </div>
                    <div class="action-btns">
                        <div class="move-btn" title="Move to tomorrow" onclick="forwardHabit(${h.id}); event.stopPropagation();">‚Üí</div>
                        <div class="delete-btn" title="Manage Task" onclick="requestDelete(this, ${h.id}); event.stopPropagation();">‚úï</div>
                    </div>
                </div>
                <div class="col-selector-wrap">
                    <div class="sq-btn ${h.col === 0 ? 'active' : ''}" onclick="moveHabit(${h.id}, 0)"></div>
                    <div class="sq-btn ${h.col === 1 ? 'active' : ''}" onclick="moveHabit(${h.id}, 1)"></div>
                    <div class="sq-btn ${h.col === 2 ? 'active' : ''}" onclick="moveHabit(${h.id}, 2)"></div>
                </div>`;
            cols[h.col ?? 1].appendChild(item);
        });
        cols[0].style.display = habits.some(h => h.col === 0) ? 'block' : 'none';
        cols[2].style.display = habits.some(h => h.col === 2) ? 'block' : 'none';
    }

    function renderYear() {
        const yearGrid = document.getElementById('yearGrid');
        yearGrid.innerHTML = '';
        const year = new Date().getFullYear();
        const activeKey = getTodayKey(viewingDate);
        ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].forEach((name, mIdx) => {
            const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
            let monthTotal = 0, daysLogged = 0;
            let monthHtml = `<div class="month-card"><div class="month-title"><span>${name}</span><span id="m-pct-${mIdx}">0%</span></div><div class="month-days">`;
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(mIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayData = state.dailyData[dateKey];
                const score = dayData ? dayData.percent : 0;
                const frogEaten = dayData && dayData.habits.some(h => h.isFrog && h.done);
                if (dayData) { monthTotal += score; daysLogged++; }
                monthHtml += `<div class="day-sq ${dateKey === activeKey ? 'active' : ''}" 
                                   onclick="jumpToDate('${dateKey}')" 
                                   style="background: rgba(59, 130, 246, ${score > 0 ? 0.2 + (score/100) * 0.8 : 0})">
                                   ${frogEaten ? 'üê∏' : ''}
                              </div>`;
            }
            yearGrid.innerHTML += monthHtml + `</div></div>`;
            setTimeout(() => { 
                const label = document.getElementById(`m-pct-${mIdx}`);
                if (label) label.innerText = (daysLogged > 0 ? Math.round(monthTotal / daysLogged) : 0) + '%';
            }, 0);
        });
    }

    function changeDate(days) { viewingDate.setDate(viewingDate.getDate() + days); saveAndRender(); }
    function jumpToToday() { viewingDate = new Date(); saveAndRender(); }
    function jumpToDate(dateStr) { viewingDate = new Date(dateStr + 'T00:00:00'); saveAndRender(); }

    saveAndRender();
</script>
</body>
</html>
