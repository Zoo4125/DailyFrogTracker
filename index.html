<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Frog Dashboard</title>
    <style>
        :root { --bg: #09090b; --card: #18181b; --text: #fafafa; --primary: #3b82f6; --border: #27272a; --success: #22c55e; --frog: #facc15; --milestone: #60a5fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; transition: background 1s ease; }
        
        .container { width: 100%; max-width: 1000px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; position: relative; z-index: 1; }
        
        /* FOCUS OVERLAY (The Dimmer) - Updated V18 */
        .focus-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; opacity: 0; pointer-events: none;
            transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 2000;
        }
        /* Reduced opacity to 0.5 and ensure clicks pass through (pointer-events: none) */
        body.focus-mode .focus-overlay { opacity: 0.5; }

        /* Fireworks */
        .firework-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 99; }
        .particle { position: absolute; width: 5px; height: 5px; border-radius: 50%; animation: explode 1.2s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--x), var(--y)); opacity: 0; } }

        /* TOAST NOTIFICATION */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(24, 24, 27, 0.95); border: 1px solid var(--primary);
            color: #fff; padding: 20px 40px; border-radius: 50px;
            font-size: 1rem; font-weight: bold; pointer-events: none;
            opacity: 0; transition: opacity 0.4s ease; z-index: 3000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
        }
        .toast.show { opacity: 1; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 4000; }
        .sync-modal { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 40px 30px; width: 90%; max-width: 400px; position: relative; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; }
        
        .modal-close { position: absolute; top: 20px; right: 20px; color: var(--success); cursor: pointer; font-weight: bold; font-size: 1.4rem; transition: 0.2s; }
        .modal-close:hover { transform: scale(1.1); }
        
        .modal-text { color: #a1a1aa; font-size: 0.9rem; margin-bottom: 25px; line-height: 1.6; text-align: center; }
        .modal-btns { display: flex; flex-direction: column; gap: 12px; width: 100%; }

        .custom-input { width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; outline: none; margin-bottom: 20px; text-align: center; }
        
        /* REMOVE SPINNERS from Number Input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .confirm-btn { background: var(--primary); color: white; border: none; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .confirm-btn:hover { opacity: 0.9; }
        textarea.custom-input { min-height: 150px; text-align: left; resize: vertical; }

        /* Routine List in Modal */
        .routine-list { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; max-height: 350px; overflow-y: auto; }
        .routine-item { display: flex; justify-content: space-between; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; font-size: 0.8rem; align-items: center; }
        
        /* Routine Icons */
        .routine-icon-group { display: flex; gap: 12px; align-items: center; }
        .routine-action.bolt { color: #facc15; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .routine-action.bolt:hover { transform: scale(1.2); color: #fff; }
        .routine-action.del { color: var(--primary); cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: 0.2s; }
        .routine-action.del:hover { transform: scale(1.2); color: #fff; }

        /* Top Section & Quote Hover */
        .today-section { text-align: center; margin-top: 40px; }
        
        .quote-wrapper { position: relative; display: inline-block; max-width: 600px; min-height: 3em; margin-bottom: 20px; }
        .quote-text { font-size: 1.1rem; color: #a1a1aa; font-style: italic; cursor: help; transition: color 0.3s; }
        .quote-text:hover { color: #fff; }
        
        .quote-text:hover::after {
            content: attr(data-author);
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            margin-top: 10px; padding: 6px 12px;
            background: #000; border: 1px solid var(--primary); color: var(--primary);
            font-size: 0.8rem; border-radius: 6px; white-space: nowrap; font-style: normal;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100;
        }

        .main-percent { font-size: 6rem; font-weight: 800; color: var(--primary); line-height: 1; transition: 0.5s; }
        .main-percent.complete { color: var(--success); text-shadow: 0 0 30px rgba(34, 197, 94, 0.6); transform: scale(1.1); }
        .label { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; color: #71717a; font-weight: 600; margin-top: 10px; }

        /* Inputs */
        .input-group { width: 100%; max-width: 500px; margin: 30px auto; display: flex; flex-direction: column; gap: 10px; }
        input { width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 18px; border-radius: 14px; box-sizing: border-box; outline: none; font-size: 1rem; text-align: center; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: #050505; }
        #frogInput { border-color: var(--frog); }

        @keyframes frogGlow { 0% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.1); } 50% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.25); } 100% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.1); } }
        .habit-item.is-frog:not(.done) { animation: frogGlow 3s infinite ease-in-out; }

        /* Board Columns & Dragging */
        .board { display: flex; justify-content: center; gap: 15px; width: 100%; margin-bottom: 50px; align-items: flex-start; flex-wrap: wrap; }
        .column { flex: 1; min-width: 300px; max-width: 320px; border-radius: 16px; padding: 5px; min-height: 100px; }
        
        .habit-item { 
            background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 10px; 
            display: flex; flex-direction: column; gap: 12px; transition: 0.2s; position: relative; cursor: grab; 
        }
        .habit-item:active { cursor: grabbing; }
        .habit-item.dragging { opacity: 0.4; border: 1px dashed var(--text); background: #000; }
        
        .habit-item.is-frog { border: 1px solid var(--frog); background: linear-gradient(145deg, #18181b, #1e1b12); }
        .habit-item.done { opacity: 0.4; border-left: 4px solid var(--primary); }
        .habit-item.is-frog.done { border-left: 4px solid var(--frog); opacity: 0.6; }
        
        .habit-row { display: flex; justify-content: space-between; align-items: center; pointer-events: none; }
        .habit-row > * { pointer-events: auto; }

        .check { width: 24px; height: 24px; border: 2px solid #3f3f3f; border-radius: 7px; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .done .check { background: var(--primary); border-color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .is-frog.done .check { background: var(--frog); border-color: var(--frog); }
        .done .check::after { content: '‚úì'; color: white; font-weight: bold; font-size: 14px; }
        
        .action-btns { display: flex; gap: 8px; align-items: center; }
        .move-btn { color: var(--primary); cursor: pointer; font-size: 1.1rem; font-weight: bold; display: none; }
        .pen-btn { color: #a1a1aa; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .pen-btn:hover { color: #fff; }
        .routine-btn { color: #facc15; cursor: pointer; font-size: 1rem; transition: 0.2s; } 
        .routine-btn:hover { color: #fff; transform: scale(1.1); }

        .delete-btn { color: var(--success); opacity: 0.8; cursor: pointer; font-size: 1.1rem; transition: 0.2s; min-width: 18px; text-align: center; }
        .delete-btn:hover { opacity: 1; }
        .delete-btn.confirm { color: var(--success); font-weight: bold; opacity: 1; }

        .col-selector-wrap { display: flex; justify-content: center; gap: 10px; border-top: 1px solid #27272a; padding-top: 10px; pointer-events: auto; }
        .sq-btn { width: 14px; height: 14px; border: 1px solid #3f3f46; border-radius: 3px; cursor: pointer; transition: 0.2s; }
        .sq-btn:hover { border-color: var(--primary); transform: scale(1.2); }
        .sq-btn.active { background: var(--success); border-color: var(--success); }

        /* Yearly Grid */
        .year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; border-top: 1px solid var(--border); padding-top: 60px; width: 100%; }
        .month-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
        .month-title { display: flex; justify-content: space-between; font-size: 0.6rem; color: #a1a1aa; margin-bottom: 8px; text-transform: uppercase; }
        .month-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        
        .day-sq { 
            width: 100%; aspect-ratio: 1; background: rgba(255, 255, 255, 0.05); border-radius: 2px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 0.5rem; position: relative; 
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.2s;
        }
        .day-sq:hover { transform: scale(1.5); z-index: 100; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); border: 1px solid var(--text); }
        .day-sq:has(+ .day-sq:hover), .day-sq:hover + .day-sq { transform: scale(1.15); z-index: 50; border-radius: 3px; }
        .month-days:has(.day-sq:hover) .day-sq:not(:hover):not(:has(+ .day-sq:hover)) { opacity: 0.6; transform: scale(0.95); }
        .day-sq:hover::after {
            content: attr(data-pct); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #000; border: 1px solid var(--primary); color: #fff; padding: 4px 8px; border-radius: 6px;
            font-size: 0.7rem; white-space: nowrap; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 200;
        }

        /* --- TROPHY & ACTIONS SECTION --- */
        .trophy-section { 
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 30px; margin: 40px 0; 
        }
        .trophy-btn { 
            font-size: 3rem; cursor: pointer; opacity: 0.3; transition: all 0.3s; 
            user-select: none;
        }
        .trophy-btn:hover { 
            opacity: 0.8; transform: scale(1.5); 
            text-shadow: 0 0 15px #ffd700; filter: drop-shadow(0 0 6px #ffd700); 
        }

        .action-icon {
            font-size: 1.8rem; cursor: pointer; opacity: 0.4; transition: all 0.3s;
        }
        .action-icon:hover { opacity: 1; transform: scale(1.2); }
        .bolt-btn { color: #facc15; }
        .broom-btn { color: #a1a1aa; } /* Gray broom */
        .broom-btn:hover { color: #fff; }

        .goals-flex { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; 
            width: 100%; max-width: 1000px; padding-bottom: 20px; 
        }
        
        .goal-card { 
            flex: 0 0 calc(25% - 12px); min-width: 200px; 
            background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; 
            display: flex; flex-direction: column; gap: 10px; position: relative; min-height: 100px;
        }
        .goal-card.done { border-color: var(--success); opacity: 0.7; }

        .add-ms-header-btn {
            width: 14px; height: 14px; 
            border: 1px solid var(--milestone); border-radius: 3px;
            background: transparent;
            cursor: pointer; transition: 0.2s;
        }
        .add-ms-header-btn:hover { background: var(--milestone); transform: scale(1.25); }

        .milestone-list { display: flex; flex-direction: column; gap: 6px; width: 100%; align-items: center; min-height: 20px; }
        .milestone-box {
            width: 90%; background: #27272a; border: 1px solid #3f3f46;
            border-radius: 6px; padding: 6px 8px; font-size: 0.7rem; color: #a1a1aa;
            text-align: center; cursor: pointer; user-select: none; position: relative;
            white-space: normal; word-wrap: break-word; transition: 0.2s;
        }
        .milestone-box:hover { color: #fff; border-color: var(--text); z-index: 5; }
        .milestone-box.done { background: var(--success); color: #000; border-color: var(--success); font-weight: bold; opacity: 1; }
        .milestone-box.dragging { opacity: 0.2; background: var(--milestone); }
        
        .ms-del { 
            position: absolute; top: 50%; right: 8px; transform: translateY(-50%);
            color: var(--primary); cursor: pointer; font-size: 0.8rem; font-weight: bold;
            opacity: 0; transition: 0.2s; z-index: 6; padding: 2px;
        }
        .milestone-box:hover .ms-del { opacity: 1; }
        .ms-del:hover { transform: scale(1.2); }
        .ms-del.confirm { color: var(--success); }

        /* Nav Bar */
        .nav-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; margin: 40px auto; padding-top: 20px; border-top: 1px solid var(--border); }
        .nav-btn { background: none; border: 1px solid var(--border); color: var(--text); padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .nav-btn:hover { background: var(--card); }
        .current-date-display { font-weight: 800; color: var(--primary); cursor: pointer; }

        /* Footer Section */
        .footer-tools { margin-top: auto; padding: 40px 0; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; position: relative; z-index: 2001; }
        
        /* New Timer Row */
        .timer-row { display: flex; gap: 15px; align-items: center; }
        .timer-btn {
            font-family: monospace; font-size: 1.2rem; color: var(--success); font-weight: bold; cursor: pointer; 
            padding: 10px 20px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); 
            border-radius: 12px; user-select: none; transition: 0.3s; min-width: 80px; text-align: center;
        }
        .timer-btn:hover { background: rgba(34, 197, 94, 0.1); transform: translateY(-2px); }
        .timer-btn.active { animation: breathe 3s infinite; border-color: var(--success); background: rgba(34, 197, 94, 0.2); }
        .timer-btn.paused { animation: none; opacity: 0.5; border-style: dashed; }
        
        /* Blue Custom Timer Style */
        #timerCustom { color: var(--primary); border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        #timerCustom:hover { background: rgba(59, 130, 246, 0.1); }
        #timerCustom.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.2); }

        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.98); } }

        /* Frog Counter */
        #frogCounter { font-size: 0.6rem; color: var(--success); opacity: 0.4; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .button-row { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .tool-btn { text-decoration: none; color: #a1a1aa; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; padding: 12px 24px; border: 1px solid #27272a; border-radius: 30px; transition: 0.3s; font-weight: bold; background: none; cursor: pointer; }
        .tool-btn:hover { background: #fff; color: #000; border-color: #fff; transform: translateY(-2px); }

        /* Expandable Sections */
        .toggle-section { width: 100%; max-width: 500px; text-align: center; }
        .toggle-link { background: none; border: none; color: #71717a; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; opacity: 0.4; transition: 0.3s; }
        .toggle-link:hover { opacity: 1; }
        .expand-box { height: 0; overflow: hidden; opacity: 0; transition: all 0.4s ease-in-out; text-align: center; }
        .expand-box.open { height: auto; opacity: 1; padding: 20px 0; }
        .instruction-box { background: rgba(17, 17, 17, 0.5); border: 1px solid rgba(39, 39, 42, 0.3); padding: 25px; border-radius: 15px; font-size: 0.75rem; color: #71717a; line-height: 1.6; }

        @media (max-width: 800px) { .year-grid, .goals-flex { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<div class="focus-overlay"></div>
<div id="firework-container" class="firework-container"></div>
<div id="toast" class="toast"></div>

<div id="syncModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeSyncModal()">‚úï</div>
        <div class="modal-text">Click Download to Download from the Cloud<br>or<br>Click Upload to Upload to the Cloud</div>
        <div class="modal-btns">
            <button onclick="cloudSync('download'); closeSyncModal()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Download</button>
            <button onclick="cloudSync('upload'); closeSyncModal()" class="tool-btn" style="border-color: var(--success); color: var(--success);">Upload</button>
        </div>
    </div>
</div>

<div id="goalInputModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeGoalModal()">‚úï</div>
        <div class="modal-text" style="font-size: 1.1rem; font-weight: bold;">Enter a longterm goal</div>
        <input type="text" id="newGoalText" class="custom-input" placeholder="e.g. Run a Marathon">
        <button onclick="confirmAddGoal()" class="confirm-btn">OK</button>
    </div>
</div>

<div id="milestoneInputModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeMilestoneModal()">‚úï</div>
        <div class="modal-text" style="font-size: 1.1rem; font-weight: bold;">Add Milestone</div>
        <input type="text" id="newMilestoneText" class="custom-input" placeholder="e.g. Read Chapter 1">
        <button onclick="confirmAddMilestone()" class="confirm-btn">Add</button>
    </div>
</div>

<div id="goalNotesModal" class="modal-overlay">
    <div class="sync-modal" style="max-width: 500px;">
        <div class="modal-close" onclick="closeNotesModal()">‚úï</div>
        <div class="modal-text" id="noteTitle">Goal Notes</div>
        <textarea id="noteText" class="custom-input" placeholder="Type your notes here..."></textarea>
        <button onclick="saveGoalNotes()" class="confirm-btn">Save Notes</button>
    </div>
</div>

<div id="goalRoutineModal" class="modal-overlay">
    <div class="sync-modal" style="max-width: 400px;">
        <div class="modal-close" onclick="closeRoutineModal()">‚úï</div>
        <div class="modal-text">Goal Routine</div>
        <div class="routine-list" id="routineList"></div>
        <input type="text" id="newRoutineTask" class="custom-input" placeholder="New task (e.g. Hangboard)" onkeypress="if(event.key==='Enter') addRoutineTask()">
        <button onclick="addAllRoutinesToToday()" class="confirm-btn">Add All to Today</button>
    </div>
</div>

<div id="dailyRoutineModal" class="modal-overlay">
    <div class="sync-modal" style="max-width: 400px;">
        <div class="modal-close" onclick="closeDailyRoutineModal()">‚úï</div>
        <div class="modal-text">Daily Routine</div>
        <div class="routine-list" id="dailyRoutineList"></div>
        <input type="text" id="newDailyRoutineTask" class="custom-input" placeholder="(e.g. take a hike)" onkeypress="if(event.key==='Enter') addDailyRoutineTask()">
        <button onclick="addAllDailyRoutinesToToday()" class="confirm-btn">Add All to Today</button>
    </div>
</div>

<div id="customTimerModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeCustomTimerModal()">‚úï</div>
        <div class="modal-text" style="font-size: 1.1rem; font-weight: bold;">Set Timer Duration</div>
        <input type="number" id="customTimerInput" class="custom-input" placeholder="Minutes (e.g. 45)" onkeypress="if(event.key==='Enter') confirmCustomTimer()">
        <button onclick="confirmCustomTimer()" class="confirm-btn">Start</button>
    </div>
</div>

<div class="container">
    <div class="today-section">
        <div class="quote-wrapper">
            <span class="quote-text" id="quoteText" data-author=""></span>
        </div>
        <div class="label" id="frogLabel">Today's Frog</div>
        <div class="main-percent" id="mainPercent">0%</div>
    </div>

    <div class="input-group">
        <input type="text" id="frogInput" placeholder="Set today's BIG FROG (one per day)...">
        <input type="text" id="habitInput" placeholder="Add another task...">
    </div>

    <div class="board">
        <div class="column" id="col-0" data-col="0"></div>
        <div class="column" id="col-1" data-col="1"></div>
        <div class="column" id="col-2" data-col="2"></div>
    </div>

    <div class="year-grid" id="yearGrid"></div>

    <div class="trophy-section">
        <div class="action-icon bolt-btn" onclick="openDailyRoutineModal()" title="Daily Routine">‚ö°</div>
        <div class="trophy-btn" onclick="openGoalModal()" title="Goals">üèÜ</div>
        <div class="action-icon broom-btn" onclick="sweepIncompleteTasks()" title="Sweep to Tomorrow">üßπ</div>
    </div>
    
    <div class="goals-flex" id="goalsGrid"></div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="changeDate(-1)">‚Üê Yesterday</button>
        <div class="current-date-display" id="dateDisplay" onclick="jumpToToday()">Date</div>
        <button class="nav-btn" onclick="changeDate(1)">Tomorrow ‚Üí</button>
    </div>

    <div class="footer-tools">
        <div class="timer-row">
            <div class="timer-btn" id="timer25" onclick="handleTimerClick(25, 'timer25')" ondblclick="resetTimer('timer25', 25)">25:00</div>
            <div class="timer-btn" id="timerCustom" onclick="openCustomTimerModal()" ondblclick="resetTimer('timerCustom', 'Custom')">Custom</div>
            <div class="timer-btn" id="timer5" onclick="handleTimerClick(5, 'timer5')" ondblclick="resetTimer('timer5', 5)">05:00</div>
        </div>

        <div id="syncStatus" style="font-size: 0.6rem; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Cloud: Unlinked</div>
        
        <div class="button-row">
            <button onclick="openSyncModal()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Sync</button>
            <button onclick="setupCloud()" class="tool-btn" style="border-color: var(--success); color: var(--success);">Link</button>
            <button onclick="resetCloud()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Reset</button>
        </div>

        <div class="button-row">
            <button onclick="playStretch()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Stretch</button>
            <button onclick="playChillVibe()" class="tool-btn" style="border-color: var(--success); color: var(--success);">Chill</button>
            <a href="https://www.brain.fm" target="_blank" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Meditate</a>
        </div>

        <div id="frogCounter">0 Frogs Eaten</div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('setupGuide', 'Setup Guide')">Show Setup Guide ‚Üì</button>
            <div id="setupGuide" class="expand-box">
                <div class="instruction-box">
                    <b>CLOUDSYNC SETUP</b><br>
                    1. Get a Master Key from JSONBin.io.<br>
                    2. Click "Link" (Green) to enter your Key.<br>
                    3. Click "Sync" then "Upload" to create your first locker.<br>
                    4. Save the generated ID to link other devices!
                </div>
            </div>
        </div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('howToUse', 'How To Use')">Show How To Use ‚Üì</button>
            <div id="howToUse" class="expand-box">
                <div class="instruction-box" style="text-align: left;">
                    <strong style="color:var(--frog)">THE PHILOSOPHY</strong><br>
                    "Eat the Frog" means doing your hardest, most important task first. That is your <b>Frog</b>. Put it in the top yellow box. It glows until it's done.<br><br>
                    
                    <strong style="color:var(--primary)">DAILY TASKS</strong><br>
                    Add other tasks below. Use the squares to move them between columns (To Do, Doing, Done) (Organized by catagory) (Or just how you're feeling).<br><br>
                    
                    <strong style="color:#facc15">GOALS (üèÜ)</strong><br>
                    Goals are persistent. Unlike daily tasks, they stay until deleted. Create milestones or set a 'Goal Routine' to quickly add related tasks to your day.<br><br>

                    <strong style="color:#facc15">DAILY ROUTINE (‚ö°)</strong><br>
                    Click the Lightning Bolt next to the Trophy to manage your daily recurring tasks.<br><br>

                    <strong style="color:#fff">SWEEP (üßπ)</strong><br>
                    Click the Broom to move all incomplete tasks to tomorrow.<br><br>
                    
                    <strong style="color:var(--success)">TIMERS</strong><br>
                    Single-click to Start/Pause. Double-click to Reset.
                </div>
            </div>
        </div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('dangerZone', 'Danger Zone')">Danger Zone ‚Üì</button>
            <div id="dangerZone" class="expand-box">
                <button onclick="clearAllData()" class="tool-btn" style="color: #ef4444; border-color: #ef4444; margin-top: 10px; font-size: 0.5rem; opacity: 0.4;">Wipe All History</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Quote Data ---
    const markTwainQuote = { text: "If it's your job to eat a frog, it's best to do it first thing in the morning. And If it's your job to eat two frogs, it's best to eat the biggest one first.", author: "Mark Twain" };
    const quotesList = [
        { text: "You do not rise to the level of your goals. You fall to the level of your systems.", author: "James Clear" },
        { text: "A year from now you may wish you had started today.", author: "Karen Lamb" },
        { text: "Start before you are ready.", author: "Steven Pressfield" },
        { text: "Long-term consistency trumps short-term intensity.", author: "Bruce Lee" },
        { text: "It is not that we have a short time to live, but that we waste a lot of it.", author: "Seneca" },
        { text: "Action is the foundational key to all success.", author: "Pablo Picasso" },
        { text: "Do what you can, with what you have, where you are.", author: "Theodore Roosevelt" },
        { text: "You have power over your mind - not outside events. Realize this, and you will find strength.", author: "Marcus Aurelius" },
        { text: "The man who moves a mountain begins by carrying away small stones.", author: "Confucius" },
        { text: "I have been impressed with the urgency of doing. Knowing is not enough; we must apply.", author: "Leonardo da Vinci" },
        { text: "Give me six hours to chop down a tree and I will spend the first four sharpening the axe.", author: "Abraham Lincoln" },
        { text: "The journey of a thousand miles begins with one step.", author: "Lao Tzu" },
        { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
        { text: "First say to yourself what you would be; and then do what you have to do.", author: "Epictetus" },
        { text: "I‚Äôm a greater believer in luck, and I find the harder I work the more I have of it.", author: "Thomas Jefferson" },
        { text: "The beginning is the most important part of the work.", author: "Plato" },
        { text: "Opportunities multiply as they are seized.", author: "Sun Tzu" },
        { text: "The secret of change is to focus all of your energy, not on fighting the old, but on building the new.", author: "Socrates" },
        { text: "Don't wait. The time will never be just right.", author: "Napoleon Hill" },
        markTwainQuote 
    ];

    // --- Victory Messages ---
    const firstVictoryQuote = "The frog is eaten. The day is won.";
    const randomVictoryQuotes = [
        "Rest easy. You have earned it.",
        "A day well spent brings happy sleep.",
        "The standard has been set.",
        "Chaos conquered.",
        "Consistency is the only magic.",
        "No regrets today.",
        "Momentum is built one day at a time.",
        "The Pain of growth is far less than the pain of regret.", 
        "Tomorrow starts with the victory of today.",
        "You are what you repeatedly do.",
        "Sleep the sleep of the just.",
        "Another brick laid. Another step taken.",
        "The mind commands, the body obeys.",
        "Respect yourself. You kept your word.",
        "Sharpen the axe. Rest now.",
        "This is what progress feels like."
    ];
    
    let state = JSON.parse(localStorage.getItem('discipline_v12')) || { dailyData: {} };
    if (!state.longTermGoals) state.longTermGoals = []; 
    // New Daily Routine State
    if (!state.dailyRoutine) state.dailyRoutine = [];

    let viewingDate = new Date();
    // Timer State (Robust)
    let activeTimer = {
        id: null,
        totalSeconds: 0,
        interval: null,
        isPaused: false
    };
    let audioCtx;
    
    let deleteTimeouts = {};
    let CLOUD_CONFIG = { key: localStorage.getItem('sync_key') || '', binId: localStorage.getItem('sync_bin_id') || '' };
    let activeGoalId = null;
    let currentGoalIdForMilestone = null;

    // --- Toast Logic ---
    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.innerText = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // --- Modal Logic ---
    function openSyncModal() { document.getElementById('syncModal').style.display = 'flex'; }
    function closeSyncModal() { document.getElementById('syncModal').style.display = 'none'; }

    function openGoalModal() { document.getElementById('goalInputModal').style.display = 'flex'; document.getElementById('newGoalText').focus(); }
    function closeGoalModal() { document.getElementById('goalInputModal').style.display = 'none'; document.getElementById('newGoalText').value = ''; }

    function openNotesModal(id) { 
        activeGoalId = id; 
        const goal = state.longTermGoals.find(g => g.id === id);
        document.getElementById('noteText').value = goal.notes || '';
        document.getElementById('goalNotesModal').style.display = 'flex'; 
    }
    function closeNotesModal() { document.getElementById('goalNotesModal').style.display = 'none'; activeGoalId = null; }

    function openMilestoneModal(id) {
        currentGoalIdForMilestone = id;
        document.getElementById('milestoneInputModal').style.display = 'flex';
        document.getElementById('newMilestoneText').focus();
    }
    function closeMilestoneModal() {
        document.getElementById('milestoneInputModal').style.display = 'none';
        document.getElementById('newMilestoneText').value = '';
        currentGoalIdForMilestone = null;
    }
    function confirmAddMilestone() {
        const text = document.getElementById('newMilestoneText').value;
        if (text && currentGoalIdForMilestone) {
            const goal = state.longTermGoals.find(g => g.id === currentGoalIdForMilestone);
            if (goal) { 
                goal.milestones.push({ id: Date.now(), text: text, done: false });
                saveAndRender();
                closeMilestoneModal();
            }
        }
    }
    document.getElementById('newMilestoneText').addEventListener('keypress', e => e.key === 'Enter' && confirmAddMilestone());

    // --- Goal Routine Logic ---
    function openRoutineModal(id) {
        activeGoalId = id;
        renderRoutineList();
        document.getElementById('goalRoutineModal').style.display = 'flex';
        document.getElementById('newRoutineTask').focus();
    }
    function closeRoutineModal() { document.getElementById('goalRoutineModal').style.display = 'none'; activeGoalId = null; }

    function renderRoutineList() {
        const goal = state.longTermGoals.find(g => g.id === activeGoalId);
        const list = document.getElementById('routineList');
        list.innerHTML = '';
        if(!goal.routine) goal.routine = [];
        
        goal.routine.forEach((task, idx) => {
            list.innerHTML += `
                <div class="routine-item">
                    <span>${task}</span>
                    <div class="routine-icon-group">
                        <span class="routine-action bolt" onclick="addSingleRoutineTask('${task}')">‚ö°</span>
                        <span class="routine-action del" onclick="deleteRoutineTask(${idx})">‚úï</span>
                    </div>
                </div>
            `;
        });
    }

    function addRoutineTask() {
        const input = document.getElementById('newRoutineTask');
        const text = input.value.trim();
        if(text && activeGoalId) {
            const goal = state.longTermGoals.find(g => g.id === activeGoalId);
            if(!goal.routine) goal.routine = [];
            goal.routine.push(text);
            input.value = '';
            saveAndRender(); 
            renderRoutineList();
        }
    }

    function deleteRoutineTask(idx) {
        if(activeGoalId) {
            const goal = state.longTermGoals.find(g => g.id === activeGoalId);
            goal.routine.splice(idx, 1);
            saveAndRender();
            renderRoutineList();
        }
    }

    // --- NEW DAILY Routine Logic (The Left Bolt) ---
    function openDailyRoutineModal() {
        renderDailyRoutineList();
        document.getElementById('dailyRoutineModal').style.display = 'flex';
        document.getElementById('newDailyRoutineTask').focus();
    }
    function closeDailyRoutineModal() { document.getElementById('dailyRoutineModal').style.display = 'none'; }

    function renderDailyRoutineList() {
        const list = document.getElementById('dailyRoutineList');
        list.innerHTML = '';
        state.dailyRoutine.forEach((task, idx) => {
            list.innerHTML += `
                <div class="routine-item">
                    <span>${task}</span>
                    <div class="routine-icon-group">
                        <span class="routine-action bolt" onclick="addSingleRoutineTask('${task}')">‚ö°</span>
                        <span class="routine-action del" onclick="deleteDailyRoutineTask(${idx})">‚úï</span>
                    </div>
                </div>
            `;
        });
    }

    function addDailyRoutineTask() {
        const input = document.getElementById('newDailyRoutineTask');
        const text = input.value.trim();
        if(text) {
            state.dailyRoutine.push(text);
            input.value = '';
            saveAndRender();
            renderDailyRoutineList();
        }
    }

    function deleteDailyRoutineTask(idx) {
        state.dailyRoutine.splice(idx, 1);
        saveAndRender();
        renderDailyRoutineList();
    }

    function addAllDailyRoutinesToToday() {
        if(state.dailyRoutine.length > 0) {
            const key = getTodayKey(viewingDate);
            if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
            
            state.dailyRoutine.forEach(taskText => {
                state.dailyData[key].habits.push({ id: Date.now() + Math.random(), text: taskText, done: false, col: 1, isFrog: false });
            });
            
            saveAndRender();
            showToast(`Added ${state.dailyRoutine.length} tasks to Today!`);
            closeDailyRoutineModal();
        } else {
            showToast("No daily routines set.");
        }
    }

    // --- Common Routine Functions ---
    function addSingleRoutineTask(taskText) {
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.push({ id: Date.now() + Math.random(), text: taskText, done: false, col: 1, isFrog: false });
        saveAndRender();
        showToast(`Added "${taskText}" to Today!`);
    }

    function addAllRoutinesToToday() {
        if(activeGoalId) {
            const goal = state.longTermGoals.find(g => g.id === activeGoalId);
            if(goal && goal.routine && goal.routine.length > 0) {
                const key = getTodayKey(viewingDate);
                if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
                
                goal.routine.forEach(taskText => {
                    state.dailyData[key].habits.push({ id: Date.now() + Math.random(), text: taskText, done: false, col: 1, isFrog: false });
                });
                
                saveAndRender();
                showToast(`Added ${goal.routine.length} tasks to Today!`);
                closeRoutineModal();
            } else {
                showToast("No tasks in routine.");
            }
        }
    }

    // --- SWEEP FEATURE (Broom) ---
    function sweepIncompleteTasks() {
        const currentKey = getTodayKey(viewingDate);
        if (!state.dailyData[currentKey] || !state.dailyData[currentKey].habits) {
            showToast("No incomplete tasks.");
            return;
        }
        
        const habits = state.dailyData[currentKey].habits;
        const incomplete = habits.filter(h => !h.done);
        
        if (incomplete.length === 0) {
            showToast("No incomplete tasks.");
            return;
        }

        // 1. Remove incomplete from current day
        state.dailyData[currentKey].habits = habits.filter(h => h.done);

        // 2. Add to tomorrow
        let tomorrow = new Date(viewingDate); 
        tomorrow.setDate(tomorrow.getDate() + 1);
        const nextKey = getTodayKey(tomorrow);
        
        if (!state.dailyData[nextKey]) state.dailyData[nextKey] = { habits: [], percent: 0 };
        
        incomplete.forEach(h => {
            state.dailyData[nextKey].habits.push({ ...h, col: 1 }); 
        });

        // 3. Save and re-render current day (Instant vanish)
        saveAndRender();
        showToast(`Swept ${incomplete.length} tasks to tomorrow.`);
    }

    function toggleElement(id, baseName) {
        const el = document.getElementById(id);
        const btn = el.previousElementSibling;
        const isOpen = el.classList.toggle('open');
        
        if (baseName === 'Danger Zone') {
             btn.innerText = `${baseName} ${isOpen ? '‚Üë' : '‚Üì'}`;
        } else {
             btn.innerText = `${isOpen ? 'Hide' : 'Show'} ${baseName} ${isOpen ? '‚Üë' : '‚Üì'}`;
        }
    }

    function playStretch() { window.open("https://www.youtube.com/playlist?list=PLWGC5pHwnCsr4tpDxsvUMgXnfHzf26Ezy", '_blank'); }
    function playChillVibe() { window.open('https://www.youtube.com/watch?v=mw4k1tCnAuE&list=PLWGC5pHwnCsrfo7aIeWRw-taMn79IBfdl', 'chillPlayer', 'width=450,height=400'); }

    function playChime() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioCtx.currentTime;
        [174, 348, 522].forEach((freq, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(freq, now);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 3);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 3.1);
        });
    }

    // --- REBUILT TIMER LOGIC ---
    // Handles single vs double click internally for robustness

    function handleTimerClick(minutes, btnId) {
        // If this timer is not active, start it
        if (activeTimer.id !== btnId) {
            startTimer(minutes, btnId);
        } else {
            // If active, toggle pause
            togglePause();
        }
    }

    function startTimer(minutes, btnId) {
        // Clear any existing timer first
        stopTimerEngine();

        // Set state
        activeTimer.id = btnId;
        activeTimer.totalSeconds = minutes * 60;
        activeTimer.isPaused = false;

        // Visuals
        const btn = document.getElementById(btnId);
        if(btn) btn.classList.add('active');
        
        playChime();
        enableFocusMode(); // Dim screen
        
        // Start Loop
        updateTimerDisplay(); // show initial time immediately
        activeTimer.interval = setInterval(tick, 1000);
    }

    function tick() {
        if(!activeTimer.isPaused) {
            activeTimer.totalSeconds--;
            updateTimerDisplay();
            
            if (activeTimer.totalSeconds <= 0) {
                timerComplete();
            }
        }
    }

    function togglePause() {
        if (!activeTimer.id) return;
        
        const btn = document.getElementById(activeTimer.id);
        if(activeTimer.isPaused) {
            // Resume
            activeTimer.isPaused = false;
            if(btn) btn.classList.remove('paused');
            enableFocusMode(); // Re-dim screen
        } else {
            // Pause
            activeTimer.isPaused = true;
            if(btn) btn.classList.add('paused');
            disableFocusMode(); // Undim screen
        }
    }

    function timerComplete() {
        stopTimerEngine();
        resetTimerUI(null); // Reset UI to defaults
        disableFocusMode();
        playChime();
        alert("Timer Complete!");
    }

    function resetTimer(btnId, defaultVal) {
        // Double click handler
        if(activeTimer.id === btnId) {
            stopTimerEngine();
            resetTimerUI(defaultVal); // Force reset text
            disableFocusMode();
        }
    }

    function stopTimerEngine() {
        if(activeTimer.interval) clearInterval(activeTimer.interval);
        activeTimer.interval = null;
        activeTimer.isPaused = false;
    }

    function resetTimerUI(val) {
        // Remove active classes from all buttons
        ['timer25', 'timerCustom', 'timer5'].forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('active', 'paused');
            // Reset text if specific value passed (for the specific button)
            if(val && id === activeTimer.id) {
                 el.innerText = (typeof val === 'number') ? (val < 10 ? '0'+val+':00' : val+':00') : val;
            }
            // Fallback resets if no specific value passed
            else if (id === 'timer25') el.innerText = "25:00";
            else if (id === 'timer5') el.innerText = "05:00";
            else if (id === 'timerCustom') el.innerText = "Custom";
        });
        activeTimer.id = null;
    }

    function updateTimerDisplay() {
        if(!activeTimer.id) return;
        const btn = document.getElementById(activeTimer.id);
        const m = Math.floor(activeTimer.totalSeconds / 60); 
        const s = activeTimer.totalSeconds % 60; 
        btn.innerText = `${m}:${s < 10 ? '0' : ''}${s}`; 
    }

    function enableFocusMode() {
        document.body.classList.add('focus-mode');
    }

    function disableFocusMode() {
        document.body.classList.remove('focus-mode');
    }

    // Custom Timer Modal
    function openCustomTimerModal() {
        // If currently running this timer, pause instead of open
        if(activeTimer.id === 'timerCustom') {
            togglePause();
            return;
        }
        document.getElementById('customTimerModal').style.display = 'flex';
        document.getElementById('customTimerInput').focus();
    }
    function closeCustomTimerModal() {
        document.getElementById('customTimerModal').style.display = 'none';
        document.getElementById('customTimerInput').value = '';
    }
    function confirmCustomTimer() {
        const input = document.getElementById('customTimerInput');
        const mins = parseInt(input.value);
        if (mins && mins > 0) {
            const btn = document.getElementById('timerCustom');
            btn.innerText = mins + ":00";
            startTimer(mins, 'timerCustom');
            closeCustomTimerModal();
        }
    }

    // --- Cloud Logic ---
    function setupCloud() {
        const key = prompt("Paste Master Key:"); if (!key) return;
        const bin = prompt("Enter Bin ID (Leave blank if creating new):");
        localStorage.setItem('sync_key', key);
        if (bin) localStorage.setItem('sync_bin_id', bin); else localStorage.removeItem('sync_bin_id');
        CLOUD_CONFIG = { key, binId: bin || '' }; updateSyncStatus("Ready");
    }

    function resetCloud() {
        if (confirm("Disconnect Cloud?")) {
            localStorage.removeItem('sync_key'); localStorage.removeItem('sync_bin_id');
            CLOUD_CONFIG = { key: '', binId: '' }; updateSyncStatus("Unlinked");
        }
    }

    async function cloudSync(type) {
        if (!CLOUD_CONFIG.key) { setupCloud(); return; }
        updateSyncStatus("Syncing...");
        try {
            if (!CLOUD_CONFIG.binId && type === 'upload') {
                const res = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key, 'X-Bin-Private': 'true' },
                    body: JSON.stringify(state)
                });
                const data = await res.json();
                if (data.metadata) {
                    localStorage.setItem('sync_bin_id', data.metadata.id);
                    CLOUD_CONFIG.binId = data.metadata.id;
                    updateSyncStatus("Linked"); alert("Bin ID Created: " + data.metadata.id);
                }
            } else {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}${type === 'download' ? '/latest' : ''}`, {
                    method: type === 'upload' ? 'PUT' : 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key },
                    body: type === 'upload' ? JSON.stringify(state) : null
                });
                const data = await res.json();
                if (type === 'download') { 
                    state = data.record; 
                    if (!state.longTermGoals) state.longTermGoals = []; 
                    if (!state.dailyRoutine) state.dailyRoutine = [];
                    saveAndRender(); 
                }
                updateSyncStatus("Synced");
            }
        } catch (e) { updateSyncStatus("Error"); }
    }

    function updateSyncStatus(msg) { document.getElementById('syncStatus').innerText = `Cloud: ${msg}`; }

    function clearAllData() {
        if (prompt("Type 'DELETE' to wipe all history:") === "DELETE") { state = { dailyData: {}, longTermGoals: [], dailyRoutine: [] }; saveAndRender(); }
    }

    // --- Task Logic ---
    function addHabit() {
        const input = document.getElementById('habitInput'); if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.push({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: false });
        input.value = ''; saveAndRender();
    }

    function addFrog() {
        const input = document.getElementById('frogInput'); if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.unshift({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: true });
        input.value = ''; saveAndRender();
    }

    function requestDelete(btn, id) {
        const arrow = btn.previousElementSibling; 
        if (btn.classList.contains('confirm')) { 
            clearTimeout(deleteTimeouts[id]); deleteHabit(id); 
        } else {
            btn.classList.add('confirm'); btn.innerText = '‚úì'; 
            if(arrow) arrow.style.display = 'block';
            deleteTimeouts[id] = setTimeout(() => { 
                btn.classList.remove('confirm'); btn.innerText = '‚úï'; 
                if(arrow) arrow.style.display = 'none';
            }, 3000);
        }
    }

    function deleteHabit(id) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.filter(h => h.id !== id); saveAndRender(); }
    function toggleHabit(id) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === id ? {...h, done: !h.done} : h); saveAndRender(); }
    function moveHabit(id, col) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === id ? {...h, col: col} : h); saveAndRender(); }
    
    function forwardHabit(id) {
        const currentKey = getTodayKey(viewingDate);
        const hToMove = state.dailyData[currentKey].habits.find(h => h.id === id);
        state.dailyData[currentKey].habits = state.dailyData[currentKey].habits.filter(h => h.id !== id);
        let tomorrow = new Date(viewingDate); tomorrow.setDate(tomorrow.getDate() + 1);
        const nextKey = getTodayKey(tomorrow);
        if (!state.dailyData[nextKey]) state.dailyData[nextKey] = { habits: [], percent: 0 };
        state.dailyData[nextKey].habits.push({ ...hToMove, done: false });
        saveAndRender();
    }

    // --- Drag and Drop (Tasks) ---
    let draggedItem = null;

    function handleDragStart(e) { draggedItem = this; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', this.dataset.id); setTimeout(() => this.classList.add('dragging'), 0); }
    function handleDragEnd(e) { this.classList.remove('dragging'); draggedItem = null; }

    function handleDragOver(e) {
        e.preventDefault();
        const container = e.currentTarget;
        if (!container.classList.contains('column')) return; 
        const afterElement = getDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.habit-item.dragging');
        if (draggable) {
            if (afterElement == null) container.appendChild(draggable);
            else container.insertBefore(draggable, afterElement);
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        const newColIndex = parseInt(e.currentTarget.dataset.col);
        const draggable = document.querySelector('.habit-item.dragging');
        if(!draggable) return;
        const id = parseInt(draggable.dataset.id);
        const key = getTodayKey(viewingDate);
        let habits = state.dailyData[key].habits;
        const habitIndex = habits.findIndex(h => h.id === id);
        if(habitIndex === -1) return;
        
        habits[habitIndex].col = newColIndex;

        const newHabitsOrder = [];
        [0, 1, 2].forEach(colIdx => {
            const colEl = document.getElementById(`col-${colIdx}`);
            const itemEls = colEl.querySelectorAll('.habit-item');
            itemEls.forEach(el => {
                const itemId = parseInt(el.dataset.id);
                const item = habits.find(h => h.id === itemId);
                if (item) { item.col = colIdx; newHabitsOrder.push(item); }
            });
        });
        state.dailyData[key].habits = newHabitsOrder;
        saveAndRender(false); 
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.habit-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // --- LONG TERM GOALS LOGIC ---
    function confirmAddGoal() {
        const text = document.getElementById('newGoalText').value;
        if (state.longTermGoals.length >= 8) { showToast("Max 8 Goals reached."); return; }
        if (text) {
            state.longTermGoals.push({ id: Date.now(), text: text, done: false, milestones: [], notes: '', routine: [] });
            saveAndRender();
            closeGoalModal();
        }
    }

    function toggleGoal(id) {
        state.longTermGoals = state.longTermGoals.map(g => g.id === id ? { ...g, done: !g.done } : g);
        saveAndRender();
    }

    function requestDeleteGoal(btn, id) {
        if (btn.classList.contains('confirm')) { 
            clearTimeout(deleteTimeouts['g'+id]); deleteGoal(id); 
        } else {
            btn.classList.add('confirm'); btn.innerText = '‚úì'; 
            deleteTimeouts['g'+id] = setTimeout(() => { 
                btn.classList.remove('confirm'); btn.innerText = '‚úï'; 
            }, 3000);
        }
    }

    function deleteGoal(id) {
        state.longTermGoals = state.longTermGoals.filter(g => g.id !== id);
        saveAndRender();
    }

    function saveGoalNotes() {
        if(activeGoalId) {
            const txt = document.getElementById('noteText').value;
            state.longTermGoals = state.longTermGoals.map(g => g.id === activeGoalId ? { ...g, notes: txt } : g);
            saveAndRender();
            closeNotesModal();
        }
    }

    function addMilestone(goalId) {
        openMilestoneModal(goalId);
    }

    function toggleMilestone(goalId, msId) {
        const goal = state.longTermGoals.find(g => g.id === goalId);
        if (goal) {
            goal.milestones = goal.milestones.map(m => m.id === msId ? { ...m, done: !m.done } : m);
            saveAndRender();
        }
    }

    function requestDeleteMilestone(btn, gId, mId, e) {
        if(e) e.stopPropagation();
        if (btn.classList.contains('confirm')) { 
            clearTimeout(deleteTimeouts['m'+mId]); deleteMilestone(gId, mId); 
        } else {
            btn.classList.add('confirm'); btn.innerText = '‚úì'; 
            deleteTimeouts['m'+mId] = setTimeout(() => { 
                btn.classList.remove('confirm'); btn.innerText = '‚úï'; 
            }, 3000);
        }
    }

    function deleteMilestone(goalId, msId) {
        const goal = state.longTermGoals.find(g => g.id === goalId);
        if (goal) {
            goal.milestones = goal.milestones.filter(m => m.id !== msId);
            saveAndRender();
        }
    }

    // Milestone Drag & Drop (Vertical)
    let draggedMs = null;
    let sourceGoalId = null;

    function handleMsDragStart(e) {
        draggedMs = this;
        sourceGoalId = parseInt(this.closest('.goal-card').dataset.id);
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => this.classList.add('dragging'), 0);
    }

    function handleMsDragEnd(e) {
        this.classList.remove('dragging');
        draggedMs = null;
        sourceGoalId = null;
    }

    function handleMsDragOver(e) {
        e.preventDefault();
        const container = e.currentTarget;
        if (parseInt(container.dataset.goalId) !== sourceGoalId) return;

        const afterElement = getMsDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.milestone-box.dragging');
        if (draggable) {
            if (afterElement == null) container.appendChild(draggable);
            else container.insertBefore(draggable, afterElement);
        }
    }

    function handleMsDrop(e) {
        e.preventDefault();
        const container = e.currentTarget;
        if (parseInt(container.dataset.goalId) !== sourceGoalId) return;

        const goalId = sourceGoalId;
        const goal = state.longTermGoals.find(g => g.id === goalId);
        
        const newMsOrder = [];
        container.querySelectorAll('.milestone-box').forEach(el => {
            const msId = parseInt(el.dataset.id);
            const item = goal.milestones.find(m => m.id === msId);
            if (item) newMsOrder.push(item);
        });

        goal.milestones = newMsOrder;
        saveAndRender();
    }

    function getMsDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.milestone-box:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function renderGoals() {
        const grid = document.getElementById('goalsGrid');
        grid.innerHTML = '';
        
        state.longTermGoals.forEach(g => {
            const card = document.createElement('div');
            card.className = `goal-card ${g.done ? 'done' : ''}`;
            card.dataset.id = g.id;
            
            let html = `
                <div class="habit-row">
                    <div class="add-ms-header-btn" onclick="addMilestone(${g.id}); event.stopPropagation();"></div>
                    <div style="flex:1; margin-left:10px; cursor:pointer;" onclick="toggleGoal(${g.id})">
                        <span style="font-weight:bold; font-size:0.9rem; color:#fff;">${g.text}</span>
                    </div>
                    <div class="action-btns">
                        <div class="pen-btn" onclick="openNotesModal(${g.id})">‚úé</div>
                        <div class="routine-btn" onclick="openRoutineModal(${g.id})">‚ö°</div>
                        <div class="delete-btn" onclick="requestDeleteGoal(this, ${g.id})">‚úï</div>
                    </div>
                </div>
            `;
            
            html += `<div class="milestone-list" data-goal-id="${g.id}">`;
            g.milestones.forEach(m => {
                html += `
                    <div class="milestone-box ${m.done ? 'done' : ''}" 
                         draggable="true" data-id="${m.id}"
                         onclick="toggleMilestone(${g.id}, ${m.id})">
                         ${m.text}
                         <div class="ms-del" onclick="requestDeleteMilestone(this, ${g.id}, ${m.id}, event)">‚úï</div>
                    </div>
                `;
            });
            html += `</div>`;

            card.innerHTML = html;
            grid.appendChild(card);
            
            const msList = card.querySelector('.milestone-list');
            msList.addEventListener('dragover', handleMsDragOver);
            msList.addEventListener('drop', handleMsDrop);
            
            card.querySelectorAll('.milestone-box').forEach(box => {
                box.addEventListener('dragstart', handleMsDragStart);
                box.addEventListener('dragend', handleMsDragEnd);
            });
        });
    }

    // --- Core Render Logic ---
    function saveAndRender(shouldRenderBoard = true) {
        const key = getTodayKey(viewingDate);
        const dayData = state.dailyData[key] || { habits: [], percent: 0 };
        const total = dayData.habits.length; const doneCount = dayData.habits.filter(h => h.done).length;
        dayData.percent = total > 0 ? Math.round((doneCount / total) * 100) : 0;
        
        document.getElementById('frogInput').style.display = dayData.habits.some(h => h.isFrog) ? 'none' : 'block';
        document.getElementById('dateDisplay').innerText = viewingDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        
        const mainEl = document.getElementById('mainPercent');
        const wasComplete = mainEl.classList.contains('complete');
        mainEl.innerText = dayData.percent + '%';
        if (dayData.percent === 100 && total > 0) {
            if (!wasComplete) triggerFireworks();
            mainEl.classList.add('complete');
            updateQuote(true);
        } else {
            mainEl.classList.remove('complete');
            updateQuote(false);
        }

        // --- LIFETIME COUNTER LOGIC ---
        let totalFrogs = 0;
        Object.values(state.dailyData).forEach(d => {
            if(d.habits) {
                d.habits.forEach(h => { if(h.isFrog && h.done) totalFrogs++; });
            }
        });
        const frogCounter = document.getElementById('frogCounter');
        if(frogCounter) frogCounter.innerText = `${totalFrogs} Frogs Eaten`;

        state.dailyData[key] = dayData; localStorage.setItem('discipline_v12', JSON.stringify(state));
        if (shouldRenderBoard) renderBoard(dayData.habits); 
        renderYear();
        renderGoals(); 
    }

    // Quote Logic
    function updateQuote(isComplete) {
        const textEl = document.getElementById('quoteText');
        
        if (isComplete) {
            const hasWonBefore = localStorage.getItem('victory_first_done');
            if (!hasWonBefore) {
                textEl.innerText = `"${firstVictoryQuote}"`;
                localStorage.setItem('victory_first_done', 'true');
            } else {
                textEl.innerText = `"${randomVictoryQuotes[Math.floor(Math.random() * randomVictoryQuotes.length)]}"`;
            }
            textEl.dataset.author = "You";
        } else {
            const hasVisited = localStorage.getItem('frog_first_visit_done');
            let selectedQuote;
            
            if (!hasVisited) {
                selectedQuote = markTwainQuote;
                localStorage.setItem('frog_first_visit_done', 'true');
            } else {
                const idx = viewingDate.getDate() % quotesList.length;
                selectedQuote = quotesList[idx];
            }
            
            textEl.innerText = `"${selectedQuote.text}"`;
            textEl.dataset.author = selectedQuote.author;
        }
    }

    function renderBoard(habits) {
        const cols = [document.getElementById('col-0'), document.getElementById('col-1'), document.getElementById('col-2')];
        cols.forEach(c => {
            c.innerHTML = '';
            c.addEventListener('dragover', handleDragOver);
            c.addEventListener('drop', handleDrop);
        });
        
        habits.forEach(h => {
            const item = document.createElement('div');
            item.className = `habit-item ${h.done ? 'done' : ''} ${h.isFrog ? 'is-frog' : ''}`;
            item.draggable = true;
            item.dataset.id = h.id;
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);

            item.innerHTML = `
                <div class="habit-row">
                    <div style="display:flex; align-items:center; flex:1;" onclick="toggleHabit(${h.id})">
                        <div class="check"></div><span style="margin-left:10px;">${h.isFrog ? 'üê∏ ' : ''}${h.text}</span>
                    </div>
                    <div class="action-btns">
                        <div class="move-btn" onclick="forwardHabit(${h.id}); event.stopPropagation();">‚Üí</div>
                        <div class="delete-btn" onclick="requestDelete(this, ${h.id}); event.stopPropagation();">‚úï</div>
                    </div>
                </div>
                <div class="col-selector-wrap">
                    <div class="sq-btn ${h.col === 0 ? 'active' : ''}" onclick="moveHabit(${h.id}, 0)"></div>
                    <div class="sq-btn ${h.col === 1 ? 'active' : ''}" onclick="moveHabit(${h.id}, 1)"></div>
                    <div class="sq-btn ${h.col === 2 ? 'active' : ''}" onclick="moveHabit(${h.id}, 2)"></div>
                </div>`;
            cols[h.col ?? 1].appendChild(item);
        });
    }

    function renderYear() {
        const grid = document.getElementById('yearGrid'); grid.innerHTML = '';
        const year = new Date().getFullYear();
        ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].forEach((name, mIdx) => {
            const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
            let monthTotal = 0, daysLogged = 0;
            let monthHtml = `<div class="month-card"><div class="month-title"><span>${name}</span><span id="m-pct-${mIdx}">0%</span></div><div class="month-days">`;
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(mIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayData = state.dailyData[dateKey];
                
                let score = 0;
                let hasFrogAndDone = false;
                if (dayData && dayData.habits && dayData.habits.length > 0) {
                    const totalTasks = dayData.habits.length;
                    const doneTasks = dayData.habits.filter(h => h.done).length;
                    score = Math.round((doneTasks / totalTasks) * 100);
                    hasFrogAndDone = dayData.habits.some(h => h.isFrog && h.done);
                    monthTotal += score; 
                    daysLogged++;
                }

                let bgStyle = 'background: rgba(255, 255, 255, 0.05)';
                if (score === 100) {
                    bgStyle = 'background: var(--success); box-shadow: 0 0 5px rgba(34, 197, 94, 0.4);';
                } else if (score > 0) {
                    bgStyle = `background: rgba(59, 130, 246, ${0.2 + (score/100)*0.8})`;
                }

                monthHtml += `<div class="day-sq ${dateKey === getTodayKey(viewingDate) ? 'active' : ''}" 
                                   onclick="jumpToDate('${dateKey}')" 
                                   style="${bgStyle}"
                                   data-pct="${score}% Completed">
                                   ${hasFrogAndDone ? 'üê∏' : ''}</div>`;
            }
            grid.innerHTML += monthHtml + `</div></div>`;
            
            const finalAvg = daysLogged > 0 ? Math.round(monthTotal / daysLogged) : 0;
            const label = document.getElementById(`m-pct-${mIdx}`);
            if (label) label.innerText = finalAvg + '%';
        });
    }

    function triggerFireworks() {
        const container = document.getElementById('firework-container');
        for (let b = 0; b < 4; b++) {
            setTimeout(() => {
                const centerX = (20 + Math.random() * 60) + '%';
                const centerY = (15 + Math.random() * 25) + '%';
                for (let i = 0; i < 55; i++) {
                    const p = document.createElement('div'); p.className = 'particle';
                    p.style.left = centerX; p.style.top = centerY;
                    const angle = Math.random() * Math.PI * 2; const dist = 100 + Math.random() * 250;
                    p.style.setProperty('--x', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--y', Math.sin(angle) * dist + 'px');
                    p.style.background = `hsl(${Math.random() * 360}, 80%, 60%)`;
                    container.appendChild(p); setTimeout(() => p.remove(), 1200);
                }
            }, b * 250);
        }
    }

    function getTodayKey(date) { return date.toISOString().split('T')[0]; }
    function changeDate(d) { viewingDate.setDate(viewingDate.getDate() + d); saveAndRender(); }
    function jumpToToday() { viewingDate = new Date(); saveAndRender(); }
    function jumpToDate(s) { viewingDate = new Date(s + 'T00:00:00'); saveAndRender(); }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; 
        
        if (e.key.toLowerCase() === 'f') {
            e.preventDefault();
            const frogInput = document.getElementById('frogInput');
            if (frogInput && frogInput.style.display !== 'none') frogInput.focus();
        } 
        else if (e.key.toLowerCase() === 'n') {
            e.preventDefault();
            document.getElementById('habitInput').focus();
        }
        else if (e.key === 'Escape') {
            closeSyncModal(); closeGoalModal(); closeNotesModal(); closeMilestoneModal(); closeRoutineModal(); closeDailyRoutineModal(); closeCustomTimerModal();
        }
    });

    document.getElementById('habitInput').addEventListener('keypress', e => e.key === 'Enter' && addHabit());
    document.getElementById('frogInput').addEventListener('keypress', e => e.key === 'Enter' && addFrog());
    document.getElementById('newGoalText').addEventListener('keypress', e => e.key === 'Enter' && confirmAddGoal());

    if (CLOUD_CONFIG.key) updateSyncStatus("Ready");
    saveAndRender();
</script>
</body>
</html>
