<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline Dashboard</title>
    <style>
        :root { --bg: #09090b; --card: #18181b; --text: #fafafa; --primary: #3b82f6; --border: #27272a; --success: #22c55e; --frog: #facc15; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; transition: background 1s ease; }
        
        body.focus-mode { background: #040405; }
        .container { width: 100%; max-width: 1000px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Fireworks */
        .firework-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 99; }
        .particle { position: absolute; width: 5px; height: 5px; border-radius: 50%; animation: explode 1.2s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--x), var(--y)); opacity: 0; } }

        /* Custom Sync Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .sync-modal { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 40px 30px; width: 90%; max-width: 400px; position: relative; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-close { position: absolute; top: 20px; right: 20px; color: var(--success); cursor: pointer; font-weight: bold; font-size: 1.4rem; transition: 0.2s; }
        .modal-close:hover { transform: scale(1.1); }
        .modal-text { color: #a1a1aa; font-size: 0.9rem; margin-bottom: 25px; line-height: 1.6; }
        .modal-btns { display: flex; flex-direction: column; gap: 12px; }

        /* Top Section */
        .today-section { text-align: center; margin-top: 40px; }
        .quote-text { font-size: 1.1rem; color: #a1a1aa; font-style: italic; display: block; margin-bottom: 20px; min-height: 3em; max-width: 600px; }
        .main-percent { font-size: 6rem; font-weight: 800; color: var(--primary); line-height: 1; transition: 0.5s; }
        .main-percent.complete { color: var(--success); text-shadow: 0 0 30px rgba(34, 197, 94, 0.6); transform: scale(1.1); }
        .label { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; color: #71717a; font-weight: 600; margin-top: 10px; }

        /* Inputs */
        .input-group { width: 100%; max-width: 500px; margin: 30px auto; display: flex; flex-direction: column; gap: 10px; }
        input { width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 18px; border-radius: 14px; box-sizing: border-box; outline: none; font-size: 1rem; text-align: center; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: #050505; }
        #frogInput { border-color: var(--frog); }

        @keyframes frogGlow { 0% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.1); } 50% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.25); } 100% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.1); } }
        .habit-item.is-frog:not(.done) { animation: frogGlow 3s infinite ease-in-out; }

        /* Board Columns */
        .board { display: flex; justify-content: center; gap: 15px; width: 100%; margin-bottom: 50px; align-items: flex-start; flex-wrap: wrap; }
        .column { flex: 1; min-width: 300px; max-width: 320px; border-radius: 16px; padding: 5px; }
        
        /* Task Cards */
        .habit-item { background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 12px; transition: 0.2s; position: relative; }
        .habit-item.is-frog { border: 1px solid var(--frog); background: linear-gradient(145deg, #18181b, #1e1b12); }
        .habit-item.done { opacity: 0.4; border-left: 4px solid var(--primary); }
        .habit-item.is-frog.done { border-left: 4px solid var(--frog); opacity: 0.6; }
        
        .habit-row { display: flex; justify-content: space-between; align-items: center; }
        .check { width: 24px; height: 24px; border: 2px solid #3f3f3f; border-radius: 7px; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .done .check { background: var(--primary); border-color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .is-frog.done .check { background: var(--frog); border-color: var(--frog); }
        .done .check::after { content: '‚úì'; color: white; font-weight: bold; font-size: 14px; }
        
        .action-btns { display: flex; gap: 12px; align-items: center; }
        .move-btn { color: var(--primary); cursor: pointer; font-size: 1.1rem; font-weight: bold; display: none; }
        .delete-btn { color: var(--success); opacity: 0.8; cursor: pointer; font-size: 1.1rem; transition: 0.2s; min-width: 18px; text-align: center; }
        .delete-btn:hover { opacity: 1; }
        .delete-btn.confirm { color: var(--success); font-weight: bold; opacity: 1; }

        .col-selector-wrap { display: flex; justify-content: center; gap: 10px; border-top: 1px solid #27272a; padding-top: 10px; }
        .sq-btn { width: 14px; height: 14px; border: 1px solid #3f3f46; border-radius: 3px; cursor: pointer; transition: 0.2s; }
        .sq-btn.active { background: var(--success); border-color: var(--success); }

        /* Yearly Grid */
        .year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; border-top: 1px solid var(--border); padding-top: 60px; width: 100%; }
        .month-card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; }
        .month-title { display: flex; justify-content: space-between; font-size: 0.6rem; color: #a1a1aa; margin-bottom: 8px; text-transform: uppercase; }
        .month-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-sq { width: 100%; aspect-ratio: 1; background: #27272a; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; position: relative; }
        .day-sq.active { outline: 2px solid var(--primary); }

        /* Nav Bar */
        .nav-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 500px; margin: 40px auto; padding-top: 20px; border-top: 1px solid var(--border); }
        .nav-btn { background: none; border: 1px solid var(--border); color: var(--text); padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .nav-btn:hover { background: var(--card); }
        .current-date-display { font-weight: 800; color: var(--primary); cursor: pointer; }

        /* Footer Section */
        .footer-tools { margin-top: auto; padding: 40px 0; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        #timerDisplay { font-family: monospace; font-size: 1.4rem; color: var(--success); font-weight: bold; cursor: pointer; padding: 12px 40px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; user-select: none; transition: 0.3s; }
        #timerDisplay.active { animation: breathe 3s infinite; border-color: var(--success); }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.98); } }
        
        .button-row { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .tool-btn { text-decoration: none; color: #a1a1aa; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; padding: 12px 24px; border: 1px solid #27272a; border-radius: 30px; transition: 0.3s; font-weight: bold; background: none; cursor: pointer; }
        .tool-btn:hover { background: #fff; color: #000; border-color: #fff; transform: translateY(-2px); }

        /* Expandable Sections */
        .toggle-section { width: 100%; max-width: 500px; text-align: center; }
        .toggle-link { background: none; border: none; color: #71717a; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; opacity: 0.4; transition: 0.3s; }
        .toggle-link:hover { opacity: 1; }
        .expand-box { height: 0; overflow: hidden; opacity: 0; transition: all 0.4s ease-in-out; text-align: center; }
        .expand-box.open { height: auto; opacity: 1; padding: 20px 0; }
        .instruction-box { background: rgba(17, 17, 17, 0.5); border: 1px solid rgba(39, 39, 42, 0.3); padding: 25px; border-radius: 15px; font-size: 0.75rem; color: #71717a; line-height: 1.6; }

        @media (max-width: 800px) { .year-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<div id="firework-container" class="firework-container"></div>

<div id="syncModal" class="modal-overlay">
    <div class="sync-modal">
        <div class="modal-close" onclick="closeSyncModal()">‚úï</div>
        <div class="modal-text">
            Click Download to Download from the Cloud<br>
            or<br>
            Click Upload to Upload to the Cloud
        </div>
        <div class="modal-btns">
            <button onclick="cloudSync('download'); closeSyncModal()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Download</button>
            <button onclick="cloudSync('upload'); closeSyncModal()" class="tool-btn" style="border-color: var(--success); color: var(--success);">Upload</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="today-section">
        <span class="quote-text" id="quoteText">"If you were to swallow a frog, do it first thing in the morning."</span>
        <div class="label" id="frogLabel">Today's Frog</div>
        <div class="main-percent" id="mainPercent">0%</div>
    </div>

    <div class="input-group">
        <input type="text" id="frogInput" placeholder="Set today's BIG FROG (one per day)...">
        <input type="text" id="habitInput" placeholder="Add another task...">
    </div>

    <div class="board">
        <div class="column" id="col-0"></div>
        <div class="column" id="col-1"></div>
        <div class="column" id="col-2"></div>
    </div>

    <div class="year-grid" id="yearGrid"></div>

    <div class="nav-bar">
        <button class="nav-btn" onclick="changeDate(-1)">‚Üê Yesterday</button>
        <div class="current-date-display" id="dateDisplay" onclick="jumpToToday()">Date</div>
        <button class="nav-btn" onclick="changeDate(1)">Next Day ‚Üí</button>
    </div>

    <div class="footer-tools">
        <div id="timerDisplay" onclick="toggleTimer()" ondblclick="resetTimer()">25:00</div>
        <div id="syncStatus" style="font-size: 0.6rem; color: #71717a; text-transform: uppercase; letter-spacing: 1px;">Cloud: Unlinked</div>
        
        <div class="button-row">
            <button onclick="openSyncModal()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Sync</button>
            <button onclick="setupCloud()" class="tool-btn" style="border-color: var(--success); color: var(--success);">Link</button>
            <button onclick="resetCloud()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Reset</button>
        </div>

        <div class="button-row">
            <button onclick="playStretch()" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Stretch</button>
            <button onclick="playChillVibe()" class="tool-btn" style="border-color: var(--success); color: var(--success);">Chill</button>
            <a href="https://www.brain.fm" target="_blank" class="tool-btn" style="border-color: var(--primary); color: var(--primary);">Meditate</a>
        </div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('setupGuide')">Show Setup Guide ‚Üì</button>
            <div id="setupGuide" class="expand-box">
                <div class="instruction-box">
                    <b>CLOUDSYNC SETUP</b><br>
                    1. Get a Master Key from JSONBin.io.<br>
                    2. Click "Link" (Green) to enter your Key.<br>
                    3. Click "Sync" then "Upload" to create your first locker.<br>
                    4. Save the generated ID to link other devices!
                </div>
            </div>
        </div>

        <div class="toggle-section">
            <button class="toggle-link" onclick="toggleElement('dangerZone')">Danger Zone ‚Üì</button>
            <div id="dangerZone" class="expand-box">
                <button onclick="clearAllData()" class="tool-btn" style="color: #ef4444; border-color: #ef4444; margin-top: 10px; font-size: 0.5rem; opacity: 0.4;">Wipe All History</button>
            </div>
        </div>
    </div>
</div>

<script>
    const frogQuotes = [
        "If you were to swallow a frog, do it first thing in the morning.",
        "If you have to eat two frogs, eat the big one first.",
        "Discipline is the bridge between goals and accomplishment.",
        "The pain of discipline is far less than the pain of regret.",
        "He who has a why to live can bear almost any how.",
        "Focus on being productive instead of busy.",
        "Excellence is not an act, but a habit.",
        "Don't wish it were easier, wish you were better.",
        "Your future self is watching you right now through memories.",
        "Discipline equals freedom."
    ];
    const victoryQuotes = ["Well done. You conquered the day.", "Consistency is power.", "Excellence is a habit.", "Discipline equals freedom.", "Rest easy. You earned it.", "The version of you tomorrow will thank you."];
    
    let state = JSON.parse(localStorage.getItem('discipline_v12')) || { dailyData: {} };
    let viewingDate = new Date();
    let timerInterval, timeLeft = 1500, audioCtx;
    let deleteTimeouts = {};
    let CLOUD_CONFIG = { key: localStorage.getItem('sync_key') || '', binId: localStorage.getItem('sync_bin_id') || '' };

    // --- Modal Logic ---
    function openSyncModal() { document.getElementById('syncModal').style.display = 'flex'; }
    function closeSyncModal() { document.getElementById('syncModal').style.display = 'none'; }

    function toggleElement(id) {
        const el = document.getElementById(id);
        const btn = el.previousElementSibling;
        const isOpen = el.classList.toggle('open');
        btn.innerText = isOpen ? `Hide ${btn.innerText.split(' ')[1]} ‚Üë` : `Show ${btn.innerText.split(' ')[1]} ‚Üì`;
    }

   function playStretch() { 
    window.open("https://www.youtube.com/playlist?list=PLWGC5pHwnCsr4tpDxsvUMgXnfHzf26Ezy", '_blank'); }
    function playChillVibe() { window.open('https://www.youtube.com/watch?v=nPb2xhiyBXE', 'chillPlayer', 'width=450,height=400'); }

    function playChime() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioCtx.currentTime;
        [174, 348, 522].forEach((freq, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(freq, now);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 3);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 3.1);
        });
    }

    function toggleTimer() {
        const el = document.getElementById('timerDisplay');
        if (timerInterval) { 
            clearInterval(timerInterval); timerInterval = null; 
            el.classList.remove('active'); document.body.classList.remove('focus-mode');
        } else {
            playChime();
            el.classList.add('active'); document.body.classList.add('focus-mode');
            timerInterval = setInterval(() => {
                timeLeft--; updateTimerUI();
                if (timeLeft <= 0) { clearInterval(timerInterval); resetTimer(); playChime(); alert("Focus complete."); }
            }, 1000);
        }
    }
    function resetTimer() { timeLeft = 1500; updateTimerUI(); document.body.classList.remove('focus-mode'); document.getElementById('timerDisplay').classList.remove('active'); }
    function updateTimerUI() { const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; document.getElementById('timerDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`; }

    // --- Cloud Logic ---
    function setupCloud() {
        const key = prompt("Paste Master Key:"); if (!key) return;
        const bin = prompt("Enter Bin ID (Leave blank if creating new):");
        localStorage.setItem('sync_key', key);
        if (bin) localStorage.setItem('sync_bin_id', bin); else localStorage.removeItem('sync_bin_id');
        CLOUD_CONFIG = { key, binId: bin || '' }; updateSyncStatus("Ready");
    }

    function resetCloud() {
        if (confirm("Disconnect Cloud?")) {
            localStorage.removeItem('sync_key'); localStorage.removeItem('sync_bin_id');
            CLOUD_CONFIG = { key: '', binId: '' }; updateSyncStatus("Unlinked");
        }
    }

    async function cloudSync(type) {
        if (!CLOUD_CONFIG.key) { setupCloud(); return; }
        updateSyncStatus("Syncing...");
        try {
            if (!CLOUD_CONFIG.binId && type === 'upload') {
                const res = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key, 'X-Bin-Private': 'true' },
                    body: JSON.stringify(state)
                });
                const data = await res.json();
                if (data.metadata) {
                    localStorage.setItem('sync_bin_id', data.metadata.id);
                    CLOUD_CONFIG.binId = data.metadata.id;
                    updateSyncStatus("Linked"); alert("Bin ID Created: " + data.metadata.id);
                }
            } else {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_CONFIG.binId}${type === 'download' ? '/latest' : ''}`, {
                    method: type === 'upload' ? 'PUT' : 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CLOUD_CONFIG.key },
                    body: type === 'upload' ? JSON.stringify(state) : null
                });
                const data = await res.json();
                if (type === 'download') { state = data.record; saveAndRender(); }
                updateSyncStatus("Synced");
            }
        } catch (e) { updateSyncStatus("Error"); }
    }

    function updateSyncStatus(msg) { document.getElementById('syncStatus').innerText = `Cloud: ${msg}`; }

    function clearAllData() {
        if (prompt("Type 'DELETE' to wipe all history:") === "DELETE") { state = { dailyData: {} }; saveAndRender(); }
    }

    // --- Task Logic ---
    function addHabit() {
        const input = document.getElementById('habitInput'); if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.push({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: false });
        input.value = ''; saveAndRender();
    }

    function addFrog() {
        const input = document.getElementById('frogInput'); if (!input.value.trim()) return;
        const key = getTodayKey(viewingDate);
        if (!state.dailyData[key]) state.dailyData[key] = { habits: [], percent: 0 };
        state.dailyData[key].habits.unshift({ id: Date.now(), text: input.value, done: false, col: 1, isFrog: true });
        input.value = ''; saveAndRender();
    }

    function requestDelete(btn, id) {
        const arrow = btn.previousElementSibling;
        if (btn.classList.contains('confirm')) { 
            clearTimeout(deleteTimeouts[id]); deleteHabit(id); 
        } else {
            btn.classList.add('confirm'); btn.innerText = '‚úì'; arrow.style.display = 'block';
            deleteTimeouts[id] = setTimeout(() => { 
                btn.classList.remove('confirm'); btn.innerText = '‚úï'; arrow.style.display = 'none'; 
            }, 3000);
        }
    }

    function deleteHabit(id) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.filter(h => h.id !== id); saveAndRender(); }
    function toggleHabit(id) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === id ? {...h, done: !h.done} : h); saveAndRender(); }
    function moveHabit(id, col) { const key = getTodayKey(viewingDate); state.dailyData[key].habits = state.dailyData[key].habits.map(h => h.id === id ? {...h, col: col} : h); saveAndRender(); }
    
    function forwardHabit(id) {
        const currentKey = getTodayKey(viewingDate);
        const hToMove = state.dailyData[currentKey].habits.find(h => h.id === id);
        state.dailyData[currentKey].habits = state.dailyData[currentKey].habits.filter(h => h.id !== id);
        let tomorrow = new Date(viewingDate); tomorrow.setDate(tomorrow.getDate() + 1);
        const nextKey = getTodayKey(tomorrow);
        if (!state.dailyData[nextKey]) state.dailyData[nextKey] = { habits: [], percent: 0 };
        state.dailyData[nextKey].habits.push({ ...hToMove, done: false });
        saveAndRender();
    }

    function saveAndRender() {
        const key = getTodayKey(viewingDate);
        const dayData = state.dailyData[key] || { habits: [], percent: 0 };
        const total = dayData.habits.length; const doneCount = dayData.habits.filter(h => h.done).length;
        dayData.percent = total > 0 ? Math.round((doneCount / total) * 100) : 0;
        
        document.getElementById('frogInput').style.display = dayData.habits.some(h => h.isFrog) ? 'none' : 'block';
        document.getElementById('dateDisplay').innerText = viewingDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        
        const mainEl = document.getElementById('mainPercent');
        const wasComplete = mainEl.classList.contains('complete');
        mainEl.innerText = dayData.percent + '%';
        if (dayData.percent === 100 && total > 0) {
            if (!wasComplete) triggerFireworks();
            mainEl.classList.add('complete');
            updateQuote(true);
        } else {
            mainEl.classList.remove('complete');
            updateQuote(false);
        }

        state.dailyData[key] = dayData; localStorage.setItem('discipline_v12', JSON.stringify(state));
        renderBoard(dayData.habits); renderYear();
    }

    function updateQuote(isComplete) {
        const textEl = document.getElementById('quoteText');
        if (isComplete) textEl.innerText = `"${victoryQuotes[Math.floor(Math.random() * victoryQuotes.length)]}"`;
        else textEl.innerText = `"${frogQuotes[viewingDate.getDate() % frogQuotes.length]}"`;
    }

    function renderBoard(habits) {
        const cols = [document.getElementById('col-0'), document.getElementById('col-1'), document.getElementById('col-2')];
        cols.forEach(c => c.innerHTML = '');
        habits.forEach(h => {
            const item = document.createElement('div');
            item.className = `habit-item ${h.done ? 'done' : ''} ${h.isFrog ? 'is-frog' : ''}`;
            item.innerHTML = `
                <div class="habit-row">
                    <div style="display:flex; align-items:center; flex:1;" onclick="toggleHabit(${h.id})">
                        <div class="check"></div><span style="margin-left:10px;">${h.isFrog ? 'üê∏ ' : ''}${h.text}</span>
                    </div>
                    <div class="action-btns">
                        <div class="move-btn" onclick="forwardHabit(${h.id}); event.stopPropagation();">‚Üí</div>
                        <div class="delete-btn" onclick="requestDelete(this, ${h.id}); event.stopPropagation();">‚úï</div>
                    </div>
                </div>
                <div class="col-selector-wrap">
                    <div class="sq-btn ${h.col === 0 ? 'active' : ''}" onclick="moveHabit(${h.id}, 0)"></div>
                    <div class="sq-btn ${h.col === 1 ? 'active' : ''}" onclick="moveHabit(${h.id}, 1)"></div>
                    <div class="sq-btn ${h.col === 2 ? 'active' : ''}" onclick="moveHabit(${h.id}, 2)"></div>
                </div>`;
            cols[h.col ?? 1].appendChild(item);
        });
    }

    function renderYear() {
        const grid = document.getElementById('yearGrid'); grid.innerHTML = '';
        const year = new Date().getFullYear();
        ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].forEach((name, mIdx) => {
            const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
            let monthTotal = 0, daysLogged = 0;
            let monthHtml = `<div class="month-card"><div class="month-title"><span>${name}</span><span id="m-pct-${mIdx}">0%</span></div><div class="month-days">`;
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(mIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayData = state.dailyData[dateKey];
                
                // --- FIX: Dynamic re-calculation for the grid ---
                let score = 0;
                let hasFrogAndDone = false;
                if (dayData && dayData.habits && dayData.habits.length > 0) {
                    const totalTasks = dayData.habits.length;
                    const doneTasks = dayData.habits.filter(h => h.done).length;
                    score = Math.round((doneTasks / totalTasks) * 100);
                    hasFrogAndDone = dayData.habits.some(h => h.isFrog && h.done);
                    monthTotal += score; 
                    daysLogged++;
                }
                
                monthHtml += `<div class="day-sq ${dateKey === getTodayKey(viewingDate) ? 'active' : ''}" onclick="jumpToDate('${dateKey}')" style="background: rgba(59, 130, 246, ${score > 0 ? 0.2 + (score/100)*0.8 : 0})">${hasFrogAndDone ? 'üê∏' : ''}</div>`;
            }
            grid.innerHTML += monthHtml + `</div></div>`;
            
            // Apply month average
            const finalAvg = daysLogged > 0 ? Math.round(monthTotal / daysLogged) : 0;
            const label = document.getElementById(`m-pct-${mIdx}`);
            if (label) label.innerText = finalAvg + '%';
        });
    }

    function triggerFireworks() {
        const container = document.getElementById('firework-container');
        for (let b = 0; b < 4; b++) {
            setTimeout(() => {
                const centerX = (20 + Math.random() * 60) + '%';
                const centerY = (15 + Math.random() * 25) + '%';
                for (let i = 0; i < 55; i++) {
                    const p = document.createElement('div'); p.className = 'particle';
                    p.style.left = centerX; p.style.top = centerY;
                    const angle = Math.random() * Math.PI * 2; const dist = 100 + Math.random() * 250;
                    p.style.setProperty('--x', Math.cos(angle) * dist + 'px');
                    p.style.setProperty('--y', Math.sin(angle) * dist + 'px');
                    p.style.background = `hsl(${Math.random() * 360}, 80%, 60%)`;
                    container.appendChild(p); setTimeout(() => p.remove(), 1200);
                }
            }, b * 250);
        }
    }

    function getTodayKey(date) { return date.toISOString().split('T')[0]; }
    function changeDate(d) { viewingDate.setDate(viewingDate.getDate() + d); saveAndRender(); }
    function jumpToToday() { viewingDate = new Date(); saveAndRender(); }
    function jumpToDate(s) { viewingDate = new Date(s + 'T00:00:00'); saveAndRender(); }

    document.getElementById('habitInput').addEventListener('keypress', e => e.key === 'Enter' && addHabit());
    document.getElementById('frogInput').addEventListener('keypress', e => e.key === 'Enter' && addFrog());

    if (CLOUD_CONFIG.key) updateSyncStatus("Ready");
    saveAndRender();
</script>
</body>
</html>
